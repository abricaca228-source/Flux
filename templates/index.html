<!DOCTYPE html>
<html>
    <head>
        <title>Flux</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        <link rel="manifest" href="/static/manifest.json">
        <link rel="icon" type="image/png" href="/static/icon.png">
        <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;800&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
        
        <style>
            :root { --bg-deep:#0f0c29; --bg-medium:#1a163a; --bg-light:#302b63; --accent-primary:#00d2ff; --accent-secondary:#3a7bd5; --text-main:#ffffff; --text-dim:#b8b8d0; --danger:#ff416c; --success:#00f260; --glass:rgba(255,255,255,0.05); --glass-border:rgba(255,255,255,0.1); }
            
            /* –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø */
            body.light-theme { --bg-deep:#f5f5f5; --bg-medium:#ffffff; --bg-light:#e8e8e8; --text-main:#1a1a1a; --text-dim:#666666; --glass:rgba(0,0,0,0.05); --glass-border:rgba(0,0,0,0.1); background: #f5f5f5; }
            body.light-theme .sidebar { background: rgba(255, 255, 255, 0.98); }
            body.light-theme .msg-row.other .msg-bubble { background: rgba(0,0,0,0.05); }
            body.light-theme .msg-row.me .msg-bubble { background: linear-gradient(135deg, #5865f2, #00d2ff); color: white; }
            
            /* –ü–†–ï–í–¨–Æ –°–°–´–õ–û–ö */
            .link-preview { margin-top: 8px; border: 1px solid var(--glass-border); border-radius: 8px; overflow: hidden; max-width: 400px; background: rgba(0,0,0,0.2); }
            .link-preview-image { width: 100%; max-height: 200px; object-fit: cover; }
            .link-preview-content { padding: 10px; }
            .link-preview-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; color: var(--accent-primary); }
            .link-preview-description { font-size: 12px; color: var(--text-dim); }
            .link-preview-url { font-size: 10px; color: var(--text-dim); opacity: 0.7; margin-top: 4px; }
            
            /* –ì–û–õ–û–°–û–í–´–ï –ö–ê–ù–ê–õ–´ */
            .voice-channel { padding: 8px 15px; margin: 2px 10px; border-radius: 12px; cursor: pointer; color: var(--text-dim); font-weight: 600; display: flex; align-items: center; transition: 0.2s; font-size: 14px; }
            .voice-channel:hover { background: var(--glass); color: white; }
            .voice-channel.active { background: linear-gradient(90deg, rgba(0, 242, 96, 0.2), transparent); color: var(--success); border-left: 3px solid var(--success); }
            .voice-icon { margin-right: 8px; font-size: 16px; }
            .voice-members-count { margin-left: auto; font-size: 11px; opacity: 0.7; }
            
            /* –†–ê–°–®–ò–†–ï–ù–ù–´–ï –≠–ú–û–î–ó–ò */
            .emoji-picker { display: none; position: absolute; bottom: 60px; right: 20px; background: rgba(15, 12, 41, 0.98); border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; width: 300px; max-height: 300px; overflow-y: auto; z-index: 1000; }
            .emoji-picker.show { display: block; }
            .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; }
            .emoji-item { font-size: 20px; cursor: pointer; padding: 5px; text-align: center; border-radius: 4px; transition: 0.2s; }
            .emoji-item:hover { background: var(--glass); transform: scale(1.2); }
            
            /* –°–¢–ò–ö–ï–†–´ */
            .sticker-picker { position: absolute; bottom: 60px; left: 20px; background: rgba(15, 12, 41, 0.98); border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; width: 350px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none; }
            .sticker-picker.show { display: block; }
            .sticker-pack-tabs { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; flex-wrap: wrap; }
            .sticker-pack-tab { padding: 8px 12px; cursor: pointer; border-radius: 6px; font-size: 12px; transition: 0.2s; background: rgba(255,255,255,0.05); }
            .sticker-pack-tab.active { background: var(--accent-primary); color: white; }
            .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .sticker-item { cursor: pointer; border-radius: 8px; overflow: hidden; transition: 0.2s; aspect-ratio: 1; background: rgba(255,255,255,0.05); }
            .sticker-item:hover { transform: scale(1.1); background: var(--glass); }
            .sticker-item img { width: 100%; height: 100%; object-fit: contain; }
            
            /* –°–¢–ê–¢–£–°–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô */
            .status-badge { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 5px; }
            .status-online { background: var(--success); box-shadow: 0 0 5px var(--success); }
            .status-offline { background: #666; }
            .status-away { background: #ffaa00; }
            .status-dnd { background: var(--danger); }
            
            /* –ù–ê–°–¢–†–û–ô–ö–ò –¢–ï–ú–´ */
            .theme-selector { display: flex; gap: 10px; margin-top: 10px; }
            .theme-btn { flex: 1; padding: 8px; border: 2px solid var(--glass-border); border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; }
            .theme-btn.active { border-color: var(--accent-primary); background: rgba(0, 210, 255, 0.1); }
            .theme-btn.dark { background: linear-gradient(135deg, #0f0c29, #1a163a); color: white; }
            .theme-btn.light { background: linear-gradient(135deg, #f5f5f5, #ffffff); color: #1a1a1a; }
            
            /* –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï @USERNAME */
            .mention-autocomplete { position: absolute; bottom: 70px; left: 20px; background: rgba(15, 12, 41, 0.98); border: 1px solid var(--glass-border); border-radius: 12px; padding: 8px; max-width: 300px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
            .mention-autocomplete.show { display: block; }
            .mention-suggestion { padding: 8px 12px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 10px; }
            .mention-suggestion:hover { background: var(--glass); }
            .mention-suggestion.active { background: rgba(0, 210, 255, 0.2); }
            .mention-suggestion img { width: 24px; height: 24px; border-radius: 50%; }
            
            /* DRAG & DROP */
            .input-wrapper.drag-over { border-color: var(--accent-primary); background: rgba(0, 210, 255, 0.1); }
            .drag-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.9); color: white; padding: 30px 50px; border-radius: 20px; font-size: 24px; z-index: 5000; display: none; pointer-events: none; }
            .drag-indicator.show { display: block; }
            
            /* –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô */
            .copy-indicator { position: fixed; bottom: 100px; right: 20px; background: var(--success); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; z-index: 5000; display: none; }
            .copy-indicator.show { display: block; animation: fadeOut 2s forwards; }
            @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
            
            /* –¶–í–ï–¢–ù–´–ï –¢–ï–ú–´ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô */
            .msg-bubble.theme-blue { background: linear-gradient(135deg, #3a7bd5, #00d2ff) !important; }
            .msg-bubble.theme-purple { background: linear-gradient(135deg, #8e2de2, #4a00e0) !important; }
            .msg-bubble.theme-green { background: linear-gradient(135deg, #00f260, #0575e6) !important; }
            .msg-bubble.theme-red { background: linear-gradient(135deg, #ff416c, #ff4b2b) !important; }
            .msg-bubble.theme-orange { background: linear-gradient(135deg, #ffaa00, #ff6b00) !important; }
            
            /* –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ì–û–õ–û–°–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô */
            .voice-waveform { display: flex; align-items: center; gap: 2px; height: 30px; margin-top: 5px; }
            .voice-bar { width: 3px; background: var(--accent-primary); border-radius: 2px; transition: height 0.1s; }
            .voice-bar.active { background: var(--success); }
            
            /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ê–ö–¢–ò–í–ù–û–°–¢–ò */
            .activity-chart { margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; }
            .activity-bar { height: 20px; background: var(--accent-primary); margin-bottom: 5px; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; color: white; font-size: 11px; }
            
            /* –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–û–ò–°–ö */
            .search-filters { display: flex; gap: 5px; margin-bottom: 10px; }
            .search-filter-btn { padding: 4px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; font-size: 11px; cursor: pointer; }
            .search-filter-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); }
            
            /* –ê–ù–ò–ú–ê–¶–ò–ò */
            @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            .msg-row { animation: slideIn 0.3s ease; }
            @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
            .recording-indicator { animation: pulse 1s infinite; }
            * { box-sizing: border-box; }
            body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: linear-gradient(135deg, var(--bg-deep), #24243e); color: var(--text-main); font-family: 'Exo 2', sans-serif; }
            #app-container { display: none; width: 100%; height: 100%; display: flex; }
            
            .sidebar { width: 280px; min-width: 280px; background: rgba(15, 12, 41, 0.98); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; height: 100%; overflow-y: auto; z-index: 20; }
            .sidebar-title { font-weight: 800; padding: 25px 20px 10px 20px; color: var(--text-dim); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
            .channel { padding: 10px 15px; margin: 2px 10px; border-radius: 12px; cursor: pointer; color: var(--text-dim); font-weight: 600; display: flex; align-items: center; transition: 0.2s; font-size: 14px; }
            .channel:hover { background: var(--glass); color: white; }
            .channel.active { background: linear-gradient(90deg, rgba(0, 210, 255, 0.1), transparent); color: white; border-left: 3px solid var(--accent-primary); }
            .dm-avatar { width: 32px; height: 32px; min-width: 32px; border-radius: 50%; margin-right: 10px; background: linear-gradient(135deg, #667eea, #764ba2); object-fit: cover; }
            .user-panel { background: rgba(0,0,0,0.2); padding: 15px 20px; display: flex; align-items: center; cursor: pointer; margin-top: auto; border-top: 1px solid var(--glass-border); }
            .my-avatar { width: 38px; height: 38px; border-radius: 50%; background-color: #5865f2; margin-right: 10px; object-fit: cover; }
            .my-info { flex-grow: 1; overflow: hidden; } .my-name { font-weight: bold; font-size: 14px; } .my-bio { font-size: 11px; color: var(--accent-primary); opacity: 0.8; }

            .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: radial-gradient(circle at top right, #1a163a 0%, #0f0c29 60%); position: relative; width: 100%; background-size: cover; background-position: center; }
            .chat-area::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15, 12, 41, 0.7); pointer-events: none; }
            .chat-header { height: 65px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; padding: 0 20px; font-weight: 800; color: white; flex-shrink: 0; background: rgba(15, 12, 41, 0.95); backdrop-filter: blur(10px); justify-content: space-between; z-index: 10; position: relative;}
            .header-left { display: flex; align-items: center; overflow: hidden; }
            .chat-info { display: flex; flex-direction: column; justify-content: center; margin-left: 5px; }
            #header-title { font-size: 16px; line-height: 1.2; }
            #header-status { font-size: 12px; color: var(--accent-primary); font-weight: normal; height: 14px; opacity: 0; transition: opacity 0.2s; font-style: italic; }
            #header-status.show { opacity: 1; }
            .header-actions { display: flex; gap: 10px; align-items: center; }
            .call-btn, .search-btn { cursor: pointer; color: var(--success); display: none; padding: 0; border-radius: 50%; border: 2px solid var(--success); width: 34px; height: 34px; align-items: center; justify-content: center; transition: 0.3s; font-size: 16px; }
            
            #messages { list-style-type: none; margin: 0; padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; z-index: 1; position: relative;}
            .msg-row { display: flex; width: 100%; align-items: flex-end; position: relative; margin-bottom: 5px; }
            .msg-row.me { justify-content: flex-end; padding-right: 10px; } .msg-row.other { justify-content: flex-start; }
            .msg-bubble { max-width: 75%; padding: 10px 16px; border-radius: 18px; position: relative; word-wrap: break-word; font-size: 15px; line-height: 1.4; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: opacity 1s ease; }
            .msg-row.other .msg-bubble { background: rgba(255, 255, 255, 0.08); border: 1px solid var(--glass-border); border-bottom-left-radius: 4px; margin-left: 8px; }
            .msg-row.me .msg-bubble { background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); color: #0f0c29; border-bottom-right-radius: 4px; font-weight: 500; }
            
            /* SPY FIX */
            .spy-hidden { 
                cursor: pointer; 
                background: rgba(40, 10, 20, 0.9) !important; 
                border: 2px dashed var(--danger) !important; 
                color: white !important; 
                user-select: none; 
                padding: 20px;
                text-align: center;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                min-width: 180px;
            }
            .spy-overlay { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 5; cursor: pointer; }
            .spy-msg { border: 2px solid var(--danger) !important; background: rgba(255, 65, 108, 0.1) !important; color: white !important; }
            .spy-header { font-size: 11px; color: var(--danger); font-weight: 800; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; text-transform: uppercase; letter-spacing: 1px; }
            .spy-timer { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

            /* –£–ü–û–ú–ò–ù–ê–ù–ò–Ø –ò –ü–ï–†–ï–°–´–õ–ö–ê */
            .mention { color: var(--accent-primary); font-weight: bold; cursor: pointer; background: rgba(0, 210, 255, 0.15); padding: 2px 4px; border-radius: 4px; }
            .mention:hover { background: rgba(0, 210, 255, 0.25); }
            .forwarded-label { font-size: 10px; color: var(--text-dim); opacity: 0.7; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
            .forwarded-label::before { content: "‚Ü™"; font-size: 12px; }
            .pinned-indicator { position: absolute; top: -8px; right: 10px; background: var(--success); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; font-weight: bold; }
            .pinned-messages-bar { background: rgba(0, 242, 96, 0.1); border-left: 3px solid var(--success); padding: 10px; margin-bottom: 15px; border-radius: 8px; }
            .pinned-messages-bar .pinned-title { font-size: 11px; color: var(--success); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
            .pinned-item { font-size: 12px; color: var(--text-dim); cursor: pointer; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
            .pinned-item:hover { color: white; }
            .pinned-item:last-child { border-bottom: none; }

            .msg-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px; }
            .read-ticks { font-size: 11px; color: #00ffea; font-weight: 900; text-shadow: 0 0 5px rgba(0,255,234,0.5); }
            
            .msg-actions { position: absolute; bottom: -35px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; z-index: 100; background: rgba(15, 12, 41, 0.95); padding: 5px 10px; border-radius: 20px; border: 1px solid var(--accent-primary); box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: none; }
            .msg-row:hover .msg-actions { opacity: 1; bottom: -25px; pointer-events: auto; }
            .msg-row.me .msg-actions { right: 10px; } .msg-row.other .msg-actions { left: 50px; }
            .action-btn { cursor: pointer; font-size: 16px; transition: 0.2s; padding: 4px; }
            .action-btn:hover { transform: scale(1.3); }

            form { padding: 0 20px 20px 20px; margin: 0; width: 100%; flex-shrink: 0; position: relative; z-index: 10;}
            .input-wrapper { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 24px; display: flex; align-items: center; padding: 5px 10px; width: 100%; backdrop-filter: blur(10px); transition: 0.3s; }
            .input-wrapper.editing { border-color: var(--success); box-shadow: 0 0 10px rgba(0, 242, 96, 0.2); }
            .input-wrapper.spy-active { border-color: var(--danger); box-shadow: 0 0 15px rgba(255, 65, 108, 0.4); background: rgba(255, 65, 108, 0.1); }
            input[type="text"] { flex-grow: 1; padding: 12px; border: none; background: transparent; color: white; outline: none; font-size: 16px; font-family: 'Exo 2'; }
            .icon-btn-input { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
            .icon-btn-input:hover { background: rgba(255,255,255,0.1); color: white; }
            .spy-btn { transition: 0.3s; } .spy-btn.active { color: var(--danger); animation: pulse 1s infinite; filter: drop-shadow(0 0 5px var(--danger)); }
            
            /* PROFILE SETTINGS GRID - –ö–†–ê–°–ò–í–û */
            .settings-buttons-row { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
            .settings-btn-item { flex: 1; text-align: center; margin: 0; font-size: 13px; padding: 10px 5px; cursor: pointer; display: block; background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); color: white; border-radius: 10px; font-weight: bold; text-transform: uppercase; }
            .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
            .settings-input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; box-sizing: border-box;}
            .full-width { grid-column: span 2; }
            
            /* AUTH & MODALS */
            .auth-container { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, #302b63 0%, #0f0c29 100%); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center;}
            .logo-f { font-size: 120px; font-weight: 900; background: linear-gradient(to bottom, #00ffff, #0055ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;}
            .login-box { width: 90%; max-width: 360px; text-align: center; }
            .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 10px; outline: none; font-size: 16px; }
            .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; font-size: 15px; text-transform: uppercase; margin-bottom: 10px; background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); }
            .link-btn { background: transparent; border: none; color: var(--accent-primary); cursor: pointer; text-decoration: underline; margin-top: 10px; display: block; width: 100%; }
            .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
            .modal-content { background: #1a163a; padding: 25px; border-radius: 20px; width: 400px; text-align: center; border: 1px solid var(--glass-border); position: relative; max-height: 90vh; overflow-y: auto;}
            .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-dim); }
            #cropper-container { max-width: 100%; height: 300px; margin-bottom: 15px; display: none; }
            #image-to-crop { max-width: 100%; }
            .hamburger { display: none; margin-right: 15px; font-size: 24px; cursor: pointer; color: white; }
            
            #search-bar { display: none; position: absolute; top: 70px; right: 20px; width: 300px; background: rgba(15, 12, 41, 0.98); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
            .search-input { width: 100%; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.1); border: none; color: white; margin-bottom: 10px; outline: none; }
            #search-results { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
            .search-result-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; font-size: 13px; cursor: pointer; border-left: 2px solid var(--accent-secondary); }
            .search-result-item:hover { background: rgba(255,255,255,0.1); }
            .sr-user { font-weight: bold; color: var(--accent-primary); font-size: 11px; }
            .sr-text { color: #b8b8d0; margin-top: 2px; }
            .date-separator { text-align: center; margin: 15px 0; position: relative; display: flex; align-items: center; justify-content: center; z-index: 1;}
            .date-separator::before, .date-separator::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); margin: 0 10px; }
            .date-label { background: rgba(255,255,255,0.1); color: var(--text-dim); font-size: 11px; padding: 4px 12px; border-radius: 12px; font-weight: bold; }
            .chat-image { max-width: 100%; max-height: 250px; width: auto; border-radius: 12px; margin-top: 5px; cursor: pointer; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.2s; }
            .file-card { display: flex; align-items: center; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 10px; margin-top: 5px; min-width: 200px; gap: 10px; cursor: pointer; transition: 0.2s; }
            .msg-row.me .file-card { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }
            .file-icon { width: 36px; height: 36px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--accent-primary); flex-shrink: 0; font-weight: bold; }
            .file-info { display: flex; flex-direction: column; overflow: hidden; }
            .file-name { font-weight: bold; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
            .file-type { font-size: 10px; opacity: 0.7; }
            .custom-player { display: flex; align-items: center; gap: 10px; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.15); padding: 8px 12px; border-radius: 14px; width: 240px; margin-top: 5px; }
            .msg-row.me .custom-player { background: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.3); }
            .play-icon { width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--accent-primary); cursor: pointer; flex-shrink: 0; transition: 0.2s; }
            .track-bar { flex-grow: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: relative; cursor: pointer; }
            .track-progress { height: 100%; width: 0%; background: white; border-radius: 2px; position: relative; transition: width 0.1s linear; }
            .track-time { font-size: 10px; width: 35px; text-align: right; font-family: monospace; opacity: 0.8; }
            .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-bottom: 2px; cursor: pointer; flex-shrink: 0;}
            .msg-row.me .avatar { display: none; }
            .username { font-weight: 700; font-size: 12px; color: var(--accent-primary); margin-bottom: 3px; display: block; cursor: pointer; }
            .timestamp { font-size: 10px; color: rgba(255,255,255,0.5); }
            .msg-row.me .timestamp { color: rgba(15, 12, 41, 0.6); }
            .edited-label { font-size: 9px; opacity: 0.7; font-style: italic; margin-left: 4px; }
            #edit-indicator { display: none; position: absolute; bottom: 85px; left: 40px; background: var(--success); color: #0f0c29; padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; }
            #reply-bar { display: none; background: rgba(0, 0, 0, 0.5); padding: 8px 20px; color: var(--text-dim); font-size: 13px; border-top: 1px solid var(--glass-border); align-items: center; }
            #reply-bar span { color: var(--accent-primary); font-weight: bold; margin-right: 5px; }
            #reply-close { margin-left: auto; cursor: pointer; font-size: 18px; }
            #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
            .call-avatar { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--accent-primary); margin-bottom: 20px; object-fit: cover; animation: pulse 2s infinite; }
            .call-actions { display: flex; gap: 40px; } .call-action-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
            .btn-answer { background: var(--success); color: white; } .btn-hangup { background: var(--danger); color: white; }
            .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; margin-left: 6px; box-shadow: 0 0 5px var(--success); display: none; vertical-align: middle;}
            .icon-btn { cursor: pointer; color: var(--text-dim); display: inline-flex; align-items: center; justify-content: center; padding: 5px; border-radius: 5px; transition: 0.2s; }
            .icon-btn:hover { color: var(--accent-primary); background: var(--glass); transform: scale(1.1); }

            @media (max-width: 768px) {
                .sidebar { position: absolute; height: 100%; transform: translateX(-100%); width: 280px; }
                .sidebar.open { transform: translateX(0); }
                .hamburger { display: block !important; }
                #overlay { display: none; position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 15; }
                #overlay.show { display: block; }
                .msg-bubble { max-width: 85%; }
                .msg-row.me { padding-right: 0; }
                #search-bar { width: 90%; right: 5%; }
            }
        </style>
    </head>
    <body>
        <div id="image-modal" class="modal" onclick="this.style.display='none'"><span class="close-btn">&times;</span><img id="modal-img" style="max-width:100%;max-height:80vh;"></div>
        <div id="call-overlay"><img id="call-avatar" class="call-avatar" src=""><div id="call-username" style="font-size:24px;font-weight:bold;color:white;margin-bottom:10px;"></div><div id="call-status" style="font-size:16px;color:#b8b8d0;margin-bottom:40px;"></div><div class="call-actions"><button id="answer-btn" class="call-action-btn btn-answer" onclick="answerCall()">üìû</button><button id="hangup-btn" class="call-action-btn btn-hangup" onclick="hangUp()">‚ùå</button></div><audio id="remote-audio" autoplay playsinline></audio></div>
        
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="document.getElementById('settings-modal').style.display='none'">&times;</span>
                <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <img id="settings-avatar-preview" style="width:100px;height:100px;border-radius:50%;margin-bottom:15px;object-fit:cover;display:block;margin-left:auto;margin-right:auto;" src="">
                
                <div id="cropper-container"><img id="image-to-crop"></div>
                <button id="crop-btn" class="btn" style="display:none;background:var(--success);" onclick="performCrop()">–û–±—Ä–µ–∑–∞—Ç—å –∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                
                <div class="settings-buttons-row">
                    <label class="settings-btn-item">–§–æ—Ç–æ<input type="file" style="display:none;" accept="image/*" onchange="startCropper(this)"></label>
                    <label class="settings-btn-item" style="background:linear-gradient(90deg, #8e2de2, #4a00e0);">–û–±–æ–∏<input type="file" style="display:none;" accept="image/*" onchange="previewWallpaper(this)"></label>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-section">
                        <div class="settings-label">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                    <input id="settings-realname" class="settings-input" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
                    <input id="settings-bio" class="settings-input" placeholder="–°—Ç–∞—Ç—É—Å (Bio)">
                    <input id="settings-location" class="settings-input" placeholder="–ì–æ—Ä–æ–¥">
                    <input id="settings-birthdate" class="settings-input" type="date">
                    </div>
                    <div class="settings-section">
                        <div class="settings-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
                        <input id="settings-phone" class="settings-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" type="tel">
                        <input id="settings-email" class="settings-input" placeholder="Email" type="email">
                        <input id="settings-social" class="settings-input" placeholder="–°–æ—Ü—Å–µ—Ç–∏">
                    </div>
                    <div class="settings-section">
                        <div class="settings-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ Telegram)</div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <input id="settings-userid" class="settings-input" placeholder="000000" maxlength="6" pattern="[0-9]{6}" style="font-family:monospace;letter-spacing:2px;">
                            <button class="btn" style="flex-shrink:0;padding:8px 15px;" onclick="updateUserId()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div style="font-size:11px;opacity:0.7;margin-top:5px;">6-–∑–Ω–∞—á–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</div>
                    </div>
                </div>
                
                <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--glass-border);">
                    <div class="settings-label">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
                    <div class="theme-selector">
                        <div class="theme-btn dark active" onclick="changeTheme('dark', this)">üåô –¢—ë–º–Ω–∞—è</div>
                        <div class="theme-btn light" onclick="changeTheme('light', this)">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</div>
                    </div>
                </div>
                
                <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--glass-border);">
                    <div class="settings-label">–°—Ç–∞—Ç—É—Å</div>
                    <select id="settings-status" class="settings-input" onchange="updateUserStatus()">
                        <option value="online">üü¢ –û–Ω–ª–∞–π–Ω</option>
                        <option value="away">üü° –û—Ç–æ—à—ë–ª</option>
                        <option value="dnd">üî¥ –ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å</option>
                        <option value="offline">‚ö´ –ù–µ –≤ —Å–µ—Ç–∏</option>
                    </select>
                </div>
                
                <button class="btn" onclick="saveProfile()" style="margin-top:20px;width:100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
        
        <div id="dm-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–ù–∞–π—Ç–∏</h2><input id="dm-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º"><button class="btn" onclick="sendFriendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div></div>
        <div id="create-group-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–ì—Ä—É–ø–ø–∞</h2><input id="group-name-input" class="settings-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><button class="btn" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button></div></div>
        <div id="add-member-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–î–æ–±–∞–≤–∏—Ç—å</h2><input id="new-member-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º"><button class="btn" onclick="addMemberToGroup()">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>
        <div id="user-profile-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="document.getElementById('user-profile-modal').style.display='none'">&times;</span><img id="view-avatar" style="width:100px;height:100px;border-radius:50%;margin-bottom:15px;object-fit:cover;" src=""><h2 id="view-username"></h2><p id="view-bio"></p><div id="view-details" style="text-align:left;margin-top:15px;"></div></div></div>

        <div id="login-screen" class="auth-container">
            <div class="logo-f">F</div>
            <div class="login-box">
                <h2>–í—Ö–æ–¥</h2>
                <input type="text" id="loginUsername" class="login-input" placeholder="–ù–∏–∫–Ω–µ–π–º" />
                <input type="password" id="loginPassword" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" />
                <div id="loginError" class="error-msg"></div>
                <button class="btn" onclick="auth('login')">–í–æ–π—Ç–∏</button>
                <button class="link-btn" onclick="showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
        </div>

        <div id="register-screen" class="auth-container" style="display:none;">
            <div class="logo-f" style="font-size: 80px;">Flux</div>
            <div class="login-box">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <input type="text" id="regUsername" class="login-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ù–∏–∫–Ω–µ–π–º" />
                <input type="password" id="regPassword" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" />
                <input type="text" id="regRealName" class="login-input" placeholder="–í–∞—à–µ –ò–º—è" />
                <div style="text-align:left;color:#b8b8d0;font-size:12px;margin-bottom:5px;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</div>
                <input type="date" id="regBirthDate" class="login-input" />
                <div id="regError" class="error-msg"></div>
                <button class="btn" onclick="auth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button class="link-btn" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</button>
            </div>
        </div>

        <div id="app-container">
            <div id="overlay" onclick="toggleSidebar()"></div>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-title">–ß–ê–¢–´ <span class="icon-btn" style="color:var(--accent-primary)" onclick="document.getElementById('create-group-modal').style.display='flex'">+</span></div><div id="groups-list"></div>
                <div class="sidebar-title">–õ–ò–ß–ù–´–ï <span class="icon-btn" style="color:var(--accent-primary)" onclick="document.getElementById('dm-modal').style.display='flex'">+</span></div><div id="dm-list"></div>
                <div id="requests-section" style="display:none;"><div class="sidebar-title" style="color:var(--success);">–ó–ê–Ø–í–ö–ò</div><div id="requests-list"></div></div>
                <div class="user-panel" onclick="openAccountSettings()"><img id="my-avatar-img" class="my-avatar" src=""><div class="my-info"><div id="my-name-text" class="my-name"></div><div id="my-bio-text" class="my-bio"></div></div><div class="settings-btn">‚öôÔ∏è</div></div>
            </div>
            <div class="chat-area" id="chat-area">
                <div class="chat-header">
                    <div class="header-left">
                        <span class="hamburger" onclick="toggleSidebar()">‚ò∞</span>
                        <div class="chat-info">
                            <div id="header-title">Flux</div>
                            <div id="header-status"></div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <span class="search-btn" onclick="toggleSearch()"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span>
                        <span id="call-btn" class="call-btn" onclick="startCall()">üìû</span>
                        <span id="add-member-btn" class="add-member-header-btn" onclick="document.getElementById('add-member-modal').style.display='flex'">+–ß–µ–ª–æ–≤–µ–∫</span>
                    </div>
                </div>
                <div id="search-bar">
                    <div class="search-filters">
                        <div class="search-filter-btn active" onclick="setSearchFilter('all', this)">–í—Å–µ</div>
                        <div class="search-filter-btn" onclick="setSearchFilter('images', this)">–ö–∞—Ä—Ç–∏–Ω–∫–∏</div>
                        <div class="search-filter-btn" onclick="setSearchFilter('files', this)">–§–∞–π–ª—ã</div>
                        <div class="search-filter-btn" onclick="setSearchFilter('links', this)">–°—Å—ã–ª–∫–∏</div>
                    </div>
                    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." oninput="doSearch(this.value)">
                    <div id="search-results"></div>
                </div>
                <div class="drag-indicator" id="drag-indicator">üìé –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
                <div class="copy-indicator" id="copy-indicator">‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>
                <ul id='messages'></ul>
                <div id="reply-bar">–û—Ç–≤–µ—Ç: <span id="reply-username"></span><div id="reply-close" onclick="cancelReply()">‚úï</div></div>
                <form action="" onsubmit="sendMessage(event)">
                    <div id="edit-indicator">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ... (Esc –æ—Ç–º–µ–Ω–∞)</div>
                    <div class="input-wrapper" id="input-box">
                        <label class="icon-btn-input"><input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5a1 1 0 0 1-2 0V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg></label>
                        <div class="icon-btn-input spy-btn" id="spy-btn" onclick="toggleSpyMode()"><svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M11 20H13V22H11V20ZM11 2H13V5H11V2ZM19.53 18.12L20.95 19.53L19.53 19.53L18.12 18.12C17.27 18.7 16.32 19.14 15.31 19.43V21.43C16.89 21.1 18.33 20.45 19.53 19.53ZM4.47 18.12C3.62 17.27 2.97 16.32 2.57 15.31H4.57C4.86 16.32 5.3 17.27 5.88 18.12L4.47 19.53L5.88 19.53L4.47 18.12ZM2.57 8.69C2.97 7.68 3.62 6.73 4.47 5.88L5.88 4.47L4.47 4.47L2.57 5.88C2.28 6.89 2.1 8 2.1 9.17H4.1C4.1 8.69 4.19 8.23 4.34 7.8L2.57 8.69ZM12 7C9.24 7 7 9.24 7 12C7 14.76 9.24 17 12 17C14.76 17 17 14.76 17 12C17 9.24 14.76 7 12 7ZM19.66 7.8L17.89 8.69C18.04 9.12 18.1 9.58 18.1 10.05H20.1C20.1 8.88 19.92 7.77 19.66 6.75V7.8Z"/></svg></div>
                        <div class="icon-btn-input" id="emoji-btn" onclick="toggleEmojiPicker()" title="–≠–º–æ–¥–∑–∏">üòÄ</div>
                        <div class="icon-btn-input" id="sticker-btn" onclick="toggleStickerPicker()" title="–°—Ç–∏–∫–µ—Ä—ã">üé≠</div>
                        <div class="mention-autocomplete" id="mention-autocomplete"></div>
                        <div class="sticker-picker" id="sticker-picker"></div>
                        <input type="text" id="messageText" autocomplete="off" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleMessageKeydown(event)" oninput="handleMessageInput(event)"/>
                        <div id="mic-btn" class="icon-btn-input mic-btn" onclick="toggleMic()"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // --- CROPPER & WALLPAPER ---
            var cropper;
            function startCropper(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('image-to-crop').src = e.target.result;
                        document.getElementById('cropper-container').style.display = 'block';
                        document.getElementById('crop-btn').style.display = 'block';
                        if(cropper) cropper.destroy();
                        cropper = new Cropper(document.getElementById('image-to-crop'), { aspectRatio: 1, viewMode: 1 });
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }
            function performCrop() {
                var canvas = cropper.getCroppedCanvas({width: 200, height: 200});
                currentUserAvatar = canvas.toDataURL(); 
                document.getElementById('settings-avatar-preview').src = currentUserAvatar;
                cropper.destroy();
                document.getElementById('cropper-container').style.display = 'none';
                document.getElementById('crop-btn').style.display = 'none';
            }
            
            function previewWallpaper(i) { 
                if(i.files[0]) { 
                    var r=new FileReader(); 
                    r.onload=e=> { 
                        // –°–ñ–ê–¢–ò–ï –û–ë–û–ï–í
                        let img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            let canvas = document.createElement('canvas');
                            let ctx = canvas.getContext('2d');
                            let maxW = 1200; 
                            let scale = maxW / img.width;
                            canvas.width = maxW;
                            canvas.height = img.height * scale;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            currentUserWallpaper = canvas.toDataURL('image/jpeg', 0.8);
                            document.getElementById("chat-area").style.backgroundImage = `url(${currentUserWallpaper})`;
                        }
                    }; 
                    r.readAsDataURL(i.files[0]); 
                } 
            }

            // --- AUTH ---
            function showRegister() { document.getElementById("login-screen").style.display = "none"; document.getElementById("register-screen").style.display = "flex"; }
            function showLogin() { document.getElementById("login-screen").style.display = "flex"; document.getElementById("register-screen").style.display = "none"; }

            async function auth(type) {
                var body = {};
                if (type === 'login') {
                    body.username = document.getElementById("loginUsername").value;
                    body.password = document.getElementById("loginPassword").value;
                } else {
                    body.username = document.getElementById("regUsername").value;
                    body.password = document.getElementById("regPassword").value;
                    body.real_name = document.getElementById("regRealName").value;
                    body.birth_date = document.getElementById("regBirthDate").value;
                }
                if(!body.username || !body.password) return;

                try {
                    let r = await fetch("/"+type, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
                    if(r.ok) {
                        if (type === 'register') { alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ."); showLogin(); } 
                        else {
                            let d = await r.json(); username=body.username; myIsAdmin=d.is_admin;
                            updateMyUI(d); loadDMs(); loadGroups(); loadRequests();
                            document.getElementById("login-screen").style.display="none"; 
                            document.getElementById("app-container").style.display="flex";
                            connectWS();
                            document.getElementById("settings-realname").value = d.real_name || "";
                            document.getElementById("settings-birthdate").value = d.birth_date || "";
                            document.getElementById("settings-location").value = d.location || "";
                            document.getElementById("settings-social").value = d.social_link || "";
                        }
                    } else { document.getElementById(type==='login'?"loginError":"regError").innerText=(await r.json()).detail; document.getElementById(type==='login'?"loginError":"regError").style.display="block"; }
                } catch(e) { alert("Network Error"); }
            }

            const ICONS = {crown:`<span style="color:gold;margin-left:4px">üëë</span>`, trash: `üóëÔ∏è`, edit: `‚úèÔ∏è`, reply: `‚Ü©Ô∏è`, pin: `üìå`, forward: `‚Ü™`};
            const notifSound = new Audio("https://cdn.freesound.org/previews/235/235911_2391840-lq.mp3");
            const ringtone = new Audio("https://cdn.freesound.org/previews/351/351239_1241198-lq.mp3"); ringtone.loop=true;
            var ws, username, currentUserAvatar, currentUserWallpaper="", tempWallpaperBase64, myIsAdmin, currentChannel, currentGroupId;
            var mediaRecorder, audioChunks=[], isRecording=false, typingTimeout, lastTypingSent=0;
            var localStream, peerConnection, callTarget, pendingOffer = null, editingMessageId = null, replyToId = null, isSpyMode = false;
            const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }, { urls: "stun:stun1.l.google.com:19302" }] };
            let lastDate = null;

            function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("show"); }
            function closeSidebarOnMobile() { if(window.innerWidth<=768) toggleSidebar(); }
            function getDefaultAvatar(n) { return `https://ui-avatars.com/api/?name=${n}&background=0f0c29&color=00d2ff&size=128&bold=true`; }
            async function openSettings() { 
                document.getElementById("settings-modal").style.display='flex'; 
                document.getElementById("settings-avatar-preview").src=currentUserAvatar; 
                document.getElementById("settings-bio").value=document.getElementById("my-bio-text").innerText;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                try {
                    const r = await fetch("/get_profile?username=" + encodeURIComponent(username));
                    if (r.ok) {
                        const u = await r.json();
                        document.getElementById("settings-realname").value = u.real_name || "";
                        document.getElementById("settings-location").value = u.location || "";
                        document.getElementById("settings-birthdate").value = u.birth_date || "";
                        document.getElementById("settings-social").value = u.social_link || "";
                        document.getElementById("settings-phone").value = u.phone || "";
                        document.getElementById("settings-email").value = u.email || "";
                        document.getElementById("settings-userid").value = u.user_id || "";
                        if (u.status) document.getElementById("settings-status").value = u.status;
                    }
                } catch(e) {}
            }
            
            async function updateUserId() {
                const newId = document.getElementById("settings-userid").value;
                if (!newId || newId.length !== 6 || !/^\d{6}$/.test(newId)) {
                    alert("ID –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä");
                    return;
                }
                try {
                    const r = await fetch("/update_user_id", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({username: username, new_user_id: newId})
                    });
                    if (r.ok) {
                        alert("ID —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!");
                    } else {
                        const err = await r.json();
                        alert(err.detail || "–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è ID");
                    }
                } catch(e) {
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                }
            }

            async function saveProfile() { 
                let body={
                    username:username, bio:document.getElementById("settings-bio").value, 
                    avatar_url:currentUserAvatar, wallpaper: currentUserWallpaper,
                    real_name:document.getElementById("settings-realname").value, 
                    location:document.getElementById("settings-location").value, 
                    birth_date:document.getElementById("settings-birthdate").value, 
                    social_link:document.getElementById("settings-social").value,
                    phone:document.getElementById("settings-phone").value,
                    email:document.getElementById("settings-email").value
                }; 
                try {
                let r=await fetch("/update_profile", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)}); 
                    if(r.ok) { 
                        let d=await r.json(); 
                        updateMyUI(d); 
                        document.getElementById("settings-modal").style.display="none"; 
                    } else {
                        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è");
                    }
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è");
                }
            }

            function updateMyUI(d) {
                currentUserAvatar = d.avatar_url && !d.avatar_url.includes("discord") ? d.avatar_url : getDefaultAvatar(username);
                currentUserWallpaper = d.wallpaper || "";
                document.getElementById("my-name-text").innerHTML = username + (d.is_admin?ICONS.crown:"");
                document.getElementById("my-bio-text").innerText = d.bio || "Online";
                document.getElementById("my-avatar-img").src = currentUserAvatar;
                if(currentUserWallpaper) document.getElementById("chat-area").style.backgroundImage = `url(${currentUserWallpaper})`;
            }

            function connectWS() {
                var proto = window.location.protocol==='https:'?'wss:':'ws:';
                ws = new WebSocket(proto+"//"+window.location.host+"/ws/"+username);
                ws.onopen = () => { if(currentChannel) requestHistory(); };
                ws.onmessage = e => {
                    var d = JSON.parse(e.data);
                    if(d.type==="call_offer") { d.sender=d.sender||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"; handleOffer(d); }
                    else if(d.type==="call_answer") handleAnswer(d);
                    else if(d.type==="new_ice_candidate") handleCandidate(d);
                    else if(d.type==="hang_up") closeCall();
                    else if(d.type==="initial_status") d.users.forEach(u=>updateStatus(u,'online'));
                    else if(d.type==="status") updateStatus(d.username, d.status);
                    else if(d.type==="profile_update") {
                        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ê–í–ê–¢–ê–†–û–í –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
                        document.querySelectorAll(".channel").forEach(el => {
                            if(el.innerText.includes(d.username)) el.querySelector("img").src = d.avatar_url || getDefaultAvatar(d.username);
                        });
                        document.querySelectorAll(".msg-row.other").forEach(el => {
                            let name = el.querySelector(".username");
                            if(name && name.innerText === d.username) {
                                let img = el.querySelector("img.avatar");
                                if(img) img.src = d.avatar_url || getDefaultAvatar(d.username);
                            }
                        });
                    }
                    else if(d.type==="message_theme_changed") {
                        let msgEl = document.getElementById('msg-' + d.message_id);
                        if (msgEl) {
                            let bubble = msgEl.querySelector('.msg-bubble');
                            if (bubble) {
                                bubble.classList.remove('theme-blue', 'theme-purple', 'theme-green', 'theme-red', 'theme-orange');
                                if (d.theme) bubble.classList.add('theme-' + d.theme);
                            }
                        }
                    }
                    else if(d.type==="message" && d.username !== username) {
                        // –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        if (document.hidden || document.visibilityState === 'hidden') {
                            showNotification(d.username, d.content.substring(0, 50), d.avatar_url);
                        }
                    }
                    else if(d.type==="mention" && d.from !== username) {
                        showNotification('–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç ' + d.from, d.content);
                    }
                    else if(d.type==="new_request") { loadRequests(); notifSound.play(); }
                    else if(d.type==="request_accepted") { loadDMs(); notifSound.play(); }
                    else if(d.type==="typing") {
                        if(d.channel === currentChannel && d.username !== username) {
                            let status = document.getElementById("header-status"); status.innerText = d.username + " –ø–µ—á–∞—Ç–∞–µ—Ç..."; status.classList.add("show");
                            clearTimeout(window.typingTimer); window.typingTimer = setTimeout(() => { status.classList.remove("show"); status.innerText = ""; }, 2500);
                        }
                    }
                    else if(d.type==="spy_start") {
                        let row = document.getElementById("msg-"+d.message_id);
                        if(row) {
                            let bub = row.querySelector(".msg-bubble");
                            if(bub.classList.contains("spy-hidden")) {
                                bub.classList.remove("spy-hidden");
                                bub.querySelector(".spy-overlay").remove(); 
                                bub.querySelector(".spy-icon").remove();
                                bub.querySelector(".spy-text").remove();
                                requestHistory(); 
                            }
                        }
                    }
                    else if(d.type==="reaction_update") { requestHistory(); } 
                    else if(d.type==="edit_update") { requestHistory(); }
                    else if(d.type==="message_pinned") { if(d.channel === currentChannel) loadPinnedMessages(); requestHistory(); }
                    else if(d.type==="mention") { 
                        if(d.channel !== currentChannel) {
                            notifSound.play().catch(()=>{});
                            alert(`–í–∞—Å —É–ø–æ–º—è–Ω—É–ª–∏ –≤ ${d.channel}: ${d.from}: ${d.content}`);
                        }
                    }
                    else if(Array.isArray(d)) { document.getElementById('messages').innerHTML=''; lastDate = null; d.reverse().forEach(addMsg); loadPinnedMessages(); }
                    else if(d.type==="delete") { var el=document.getElementById("msg-"+d.message_id); if(el)el.remove(); loadPinnedMessages(); }
                    else if(d.channel===currentChannel) { addMsg(d); if(d.username!==username) { notifSound.play().catch(()=>{}); ws.send(JSON.stringify({type:"mark_read", message_id: d.id})); } }
                };
            }

            // --- ONLINE-–°–¢–ê–¢–£–°–´ ---
            function updateStatus(user, status) {
                const dot = document.getElementById("status-" + user);
                if (dot) {
                    dot.className = "status-badge status-" + status;
                    dot.style.display = status === "offline" ? "none" : "inline-block";
                }
            }

            function revealSpy(id) { ws.send(JSON.stringify({type: "spy_viewed", message_id: id})); }

            function startSpyTimer(id, seconds) {
                let timerEl = document.getElementById(`timer-${id}`); if (!timerEl) return;
                let timeLeft = seconds;
                let timerId = setInterval(() => {
                    timeLeft--; if(timerEl) timerEl.innerText = timeLeft + "—Å";
                    if(timeLeft <= 0) { clearInterval(timerId); let row = document.getElementById(`msg-${id}`); if(row) { row.style.opacity = '0'; setTimeout(() => row.remove(), 1000); } }
                }, 1000);
            }

            function addMsg(d) {
                var l = document.getElementById('messages'); if(document.getElementById("msg-"+d.id))return;
                if (lastDate === null) { let sep = document.createElement('div'); sep.className = "date-separator"; sep.innerHTML = `<span class="date-label">–°–µ–≥–æ–¥–Ω—è</span>`; l.appendChild(sep); lastDate = "Today"; }

                var me = d.username===username;
                var li = document.createElement('li'); li.className = "msg-row "+(me?"me":"other"); li.id="msg-"+d.id;
                
                let bubbleClass = "msg-bubble";
                let contentHtml = "";
                let isHidden = false;
                let spyHeader = "";

                if(d.timer > 0) {
                    bubbleClass += " spy-msg";
                    if (d.viewed_at) {
                        let elapsed = (Date.now()/1000) - parseFloat(d.viewed_at);
                        let left = 10 - elapsed;
                        if (left <= 0) return; 
                        spyHeader = `<div class="spy-header">üî• <span id="timer-${d.id}" class="spy-timer">${Math.floor(left)}—Å</span></div>`;
                        startSpyTimer(d.id, Math.floor(left));
                    } else {
                        if (me) { spyHeader = `<div class="spy-header">üî• –û–∂–∏–¥–∞–Ω–∏–µ...</div>`; } 
                        else { isHidden = true; bubbleClass += " spy-hidden"; }
                    }
                }

                if (isHidden) {
                    contentHtml = `<div class="spy-overlay" onclick="revealSpy(${d.id})"></div><div class="spy-icon">üîí</div><div class="spy-text">–ù–ê–ñ–ú–ò–¢–ï –î–õ–Ø –ü–†–û–°–ú–û–¢–†–ê</div>`;
                } else {
                    if (d.content.startsWith("data:image")) contentHtml = `${spyHeader}<img src="${d.content}" class="chat-image" onclick="document.getElementById('image-modal').style.display='flex';document.getElementById('modal-img').src=this.src;">`;
                    else if (d.content.startsWith("data:audio")) contentHtml = `${spyHeader}<div class="custom-player"><div class="play-icon" onclick="toggleAudio(${d.id})">‚ñ∂</div><div class="track-bar" onclick="seekAudio(event, ${d.id})"><div id="prog-${d.id}" class="track-progress"></div></div><div id="time-${d.id}" class="track-time">0:00</div><audio id="audio-${d.id}" src="${d.content}" ontimeupdate="updateAudioProgress(${d.id})" onended="resetAudio(${d.id})" onloadedmetadata="setAudioDuration(${d.id})"></audio></div>`;
                    else if (d.content.startsWith("[FILE:")) {
                        let closeBracket = d.content.indexOf("]"); let fileName = d.content.substring(6, closeBracket); let fileData = d.content.substring(closeBracket + 1);
                        contentHtml = `${spyHeader}<div class="file-card" onclick="downloadFile('${fileName}', '${fileData}')"><div class="file-icon">üìÑ</div><div class="file-info"><div class="file-name">${fileName}</div><div class="file-type">–°–∫–∞—á–∞—Ç—å</div></div></div>`;
                    }
                    else {
                        // –ü–∞—Ä—Å–∏–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è @username –∏ –¥–µ–ª–∞–µ–º –∏—Ö –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
                        let processedContent = d.content.replace(/@(\w+)/g, '<span class="mention" onclick="openUserProfile(\'$1\')">@$1</span>');
                        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É
                        let forwardedLabel = d.forwarded_from ? `<div class="forwarded-label">–ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç ${d.forwarded_from}</div>` : "";
                        contentHtml = `${spyHeader}${forwardedLabel}<span class="content-text">${processedContent}</span>`;
                    }
                }

                let ticks = me ? `<span class="read-ticks">${d.read_by && d.read_by.length > 0 ? "‚úì‚úì" : "‚úì"}</span>` : "";
                let replyHtml = d.reply_preview ? `<div style="font-size:11px;margin-bottom:5px;opacity:0.7;border-left:2px solid white;padding-left:5px;"><b>${d.reply_preview.username}</b>: ${d.reply_preview.content.substring(0, 20)}...</div>` : "";
                
                let reactionsHtml = "";
                if(d.reactions && Object.keys(d.reactions).length > 0) {
                    reactionsHtml = '<div class="reactions-display">';
                    for (const [emoji, users] of Object.entries(d.reactions)) { reactionsHtml += `<div class="reaction-pill" onclick="sendReaction(${d.id}, '${emoji}')">${emoji} ${users.length}</div>`; }
                    reactionsHtml += '</div>';
                }

                var pinBtn = (myIsAdmin || me) ? `<span class="action-btn" onclick="togglePin(${d.id})" title="${d.is_pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'}">${ICONS.pin}</span>` : "";
                var forwardBtn = !d.content.startsWith("data:") && !isHidden ? `<span class="action-btn" onclick="forwardMessage(${d.id})" title="–ü–µ—Ä–µ—Å–ª–∞—Ç—å">${ICONS.forward}</span>` : "";
                var copyBtn = `<span class="action-btn" onclick="copyMessage(${d.id})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</span>`;
                var themeBtn = (me || myIsAdmin) ? `<span class="action-btn" onclick="showMessageThemePicker(${d.id})" title="–¢–µ–º–∞">üé®</span>` : "";
                var actions = `<div class="msg-actions">${copyBtn}<span class="action-btn" onclick="startReply(${d.id}, '${d.username}')">${ICONS.reply}</span>${forwardBtn}${pinBtn}${themeBtn}${(me || myIsAdmin) && !d.content.startsWith("data:") && !isHidden ? `<span class="action-btn" onclick="startEdit(${d.id}, this)">${ICONS.edit}</span>` : ""}${(me || myIsAdmin) ? `<span class="action-btn" style="color:var(--danger)" onclick="delMsg(${d.id})">${ICONS.trash}</span>` : ""}<span class="action-btn" onclick="sendReaction(${d.id}, 'üëç')">üëç</span><span class="action-btn" onclick="sendReaction(${d.id}, '‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="action-btn" onclick="sendReaction(${d.id}, 'üòÇ')">üòÇ</span></div>`;

                const nameHtml = !me ? `<span class="username">${d.username}</span>${d.is_admin ? ICONS.crown : ""}` : "";

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                let pinnedBadge = d.is_pinned ? `<div class="pinned-indicator">üìå</div>` : "";
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
                if (d.message_theme) bubbleClass += " theme-" + d.message_theme;
                var info = `<div class="${bubbleClass}" style="position:relative;">${pinnedBadge}${replyHtml}${nameHtml}${contentHtml}${reactionsHtml}<div class="msg-meta">${ticks}<span class="timestamp">${d.created_at}</span></div>${actions}</div>`;
                li.innerHTML = me ? info : `<img class="avatar" src="${d.avatar_url||getDefaultAvatar(d.username)}">` + info;

                // –ö–ª–∏–∫–∞–µ–º –ø–æ –∞–≤–∞—Ç–∞—Ä—É/–Ω–∏–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!me) {
                    const avatarEl = li.querySelector(".avatar");
                    const nameEl = li.querySelector(".username");
                    if (avatarEl) avatarEl.onclick = () => openUserProfile(d.username);
                    if (nameEl) nameEl.onclick = () => openUserProfile(d.username);
                }

                l.appendChild(li); l.scrollTop=l.scrollHeight;
                if (!me && !d.timer) ws.send(JSON.stringify({type:"mark_read", message_id: d.id}));
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (d.link_preview && d.link_preview.title) {
                    setTimeout(() => {
                        let bubble = li.querySelector('.msg-bubble');
                        if (bubble) {
                            let previewDiv = document.createElement("div");
                            previewDiv.className = "link-preview";
                            let html = `<div class="link-preview-content">`;
                            if (d.link_preview.image) html += `<img src="${d.link_preview.image}" class="link-preview-image" onerror="this.style.display='none'">`;
                            html += `<div class="link-preview-title">${d.link_preview.title}</div>`;
                            if (d.link_preview.description) html += `<div class="link-preview-description">${d.link_preview.description}</div>`;
                            html += `<div class="link-preview-url">${d.link_preview.url}</div></div>`;
                            previewDiv.innerHTML = html;
                            previewDiv.onclick = () => window.open(d.link_preview.url, '_blank');
                            bubble.appendChild(previewDiv);
                        }
                    }, 100);
                }
            }

            window.downloadFile = function(name, data) { var a = document.createElement("a"); a.href = data; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
            window.toggleSearch = function() { var sb = document.getElementById("search-bar"); sb.style.display = (sb.style.display === "block") ? "none" : "block"; if(sb.style.display === "block") document.querySelector(".search-input").focus(); }
            let searchTimeout;
            let searchFilter = 'all';
            function setSearchFilter(filter, el) {
                searchFilter = filter;
                document.querySelectorAll('.search-filter-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
                doSearch(document.querySelector('.search-input').value);
            }
            function doSearch(query) { clearTimeout(searchTimeout); searchTimeout = setTimeout(async () => { if(query.length < 2) { document.getElementById("search-results").innerHTML=""; return; } let r = await fetch(`/search?channel=${currentChannel}&query=${query}`); let data = await r.json(); let html = ""; data.forEach(m => { 
                if (searchFilter === 'images' && !m.content.startsWith('data:image')) return;
                if (searchFilter === 'files' && !m.content.startsWith('data:')) return;
                if (searchFilter === 'links' && !m.content.match(/https?:\/\//)) return;
                html += `<div class="search-result-item"><div class="sr-user">${m.username} <span style="opacity:0.5;float:right">${m.created_at}</span></div><div class="sr-text">${m.content}</div></div>`; 
            }); document.getElementById("search-results").innerHTML = html || "<div style='padding:10px;color:gray;text-align:center'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>"; }, 500); }
            
            // –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï @USERNAME
            let mentionSuggestions = [];
            let mentionIndex = -1;
            function handleMessageInput(e) {
                let input = e.target;
                let text = input.value;
                let cursorPos = input.selectionStart;
                let beforeCursor = text.substring(0, cursorPos);
                let match = beforeCursor.match(/@(\w*)$/);
                let autocomplete = document.getElementById("mention-autocomplete");
                
                if (match) {
                    let query = match[1].toLowerCase();
                    fetch(`/search_users?query=${query}`).then(r => r.json()).then(users => {
                        mentionSuggestions = users;
                        mentionIndex = -1;
                        if (users.length > 0) {
                            autocomplete.innerHTML = users.map((u, i) => 
                                `<div class="mention-suggestion ${i === 0 ? 'active' : ''}" onclick="selectMention('${u.username}')">
                                    <img src="${u.avatar_url || '/static/default-avatar.png'}" onerror="this.src='/static/default-avatar.png'">
                                    <span>${u.username}</span>
                                </div>`
                            ).join('');
                            autocomplete.classList.add('show');
                        } else {
                            autocomplete.classList.remove('show');
                        }
                    });
                } else {
                    autocomplete.classList.remove('show');
                }
            }
            function handleMessageKeydown(e) {
                let autocomplete = document.getElementById("mention-autocomplete");
                if (autocomplete.classList.contains('show')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        mentionIndex = Math.min(mentionIndex + 1, mentionSuggestions.length - 1);
                        updateMentionSelection();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        mentionIndex = Math.max(mentionIndex - 1, -1);
                        updateMentionSelection();
                    } else if (e.key === 'Enter' && mentionIndex >= 0) {
                        e.preventDefault();
                        selectMention(mentionSuggestions[mentionIndex].username);
                    } else if (e.key === 'Escape') {
                        autocomplete.classList.remove('show');
                    }
                }
            }
            function updateMentionSelection() {
                document.querySelectorAll('.mention-suggestion').forEach((el, i) => {
                    el.classList.toggle('active', i === mentionIndex);
                });
            }
            function selectMention(username) {
                let input = document.getElementById("messageText");
                let text = input.value;
                let cursorPos = input.selectionStart;
                let beforeCursor = text.substring(0, cursorPos);
                let afterCursor = text.substring(cursorPos);
                let match = beforeCursor.match(/@(\w*)$/);
                if (match) {
                    let newText = beforeCursor.substring(0, match.index) + '@' + username + ' ' + afterCursor;
                    input.value = newText;
                    input.focus();
                    input.setSelectionRange(newText.length - afterCursor.length, newText.length - afterCursor.length);
                }
                document.getElementById("mention-autocomplete").classList.remove('show');
            }
            
            // –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô
            window.copyMessage = function(msgId) {
                let msgEl = document.getElementById('msg-' + msgId);
                if (!msgEl) return;
                let content = msgEl.querySelector('.content-text') || msgEl.querySelector('.msg-bubble');
                if (!content) return;
                let text = content.innerText || content.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    let indicator = document.getElementById('copy-indicator');
                    indicator.classList.add('show');
                    setTimeout(() => indicator.classList.remove('show'), 2000);
                });
            }
            
            // –¢–ï–ú–´ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô
            window.showMessageThemePicker = function(msgId) {
                let themes = ['blue', 'purple', 'green', 'red', 'orange'];
                let picker = document.createElement('div');
                picker.style.cssText = 'position:fixed;background:rgba(15,12,41,0.98);border:1px solid var(--glass-border);border-radius:12px;padding:10px;z-index:5000;display:flex;gap:5px;';
                themes.forEach(theme => {
                    let btn = document.createElement('div');
                    btn.style.cssText = `width:30px;height:30px;border-radius:50%;cursor:pointer;background:linear-gradient(135deg, var(--accent-${theme === 'blue' ? 'primary' : theme}));`;
                    btn.onclick = () => {
                        fetch('/set_message_theme', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message_id:msgId, theme:theme})});
                        picker.remove();
                    };
                    picker.appendChild(btn);
                });
                let msgEl = document.getElementById('msg-' + msgId);
                if (msgEl) {
                    let rect = msgEl.getBoundingClientRect();
                    picker.style.top = (rect.top - 40) + 'px';
                    picker.style.left = rect.left + 'px';
                    document.body.appendChild(picker);
                    setTimeout(() => document.addEventListener('click', function remover() { picker.remove(); document.removeEventListener('click', remover); }), 100);
                }
            }
            
            // DRAG & DROP
            let inputBox = document.getElementById('input-box');
            if (inputBox) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    inputBox.addEventListener(eventName, preventDefaults, false);
                });
                function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
                ['dragenter', 'dragover'].forEach(eventName => {
                    inputBox.addEventListener(eventName, () => {
                        inputBox.classList.add('drag-over');
                        document.getElementById('drag-indicator').classList.add('show');
                    }, false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    inputBox.addEventListener(eventName, () => {
                        inputBox.classList.remove('drag-over');
                        document.getElementById('drag-indicator').classList.remove('show');
                    }, false);
                });
                inputBox.addEventListener('drop', (e) => {
                    let files = Array.from(e.dataTransfer.files);
                    files.forEach(file => {
                        let input = document.getElementById('fileInput');
                        let dt = new DataTransfer();
                        dt.items.add(file);
                        input.files = dt.files;
                        handleFileSelect(input);
                    });
                }, false);
            }
            
            // –ë–†–ê–£–ó–ï–†–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            function showNotification(title, body, icon) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body, icon: icon || '/static/default-avatar.png', tag: 'flux-notification' });
                }
            }
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –û–ë–†–ê–ë–û–¢–ö–£ –°–û–û–ë–©–ï–ù–ò–ô –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
            let originalOnMessage = ws.onmessage;
            if (ws) {
                ws.onmessage = function(e) {
                    originalOnMessage(e);
                    try {
                        let d = JSON.parse(e.data);
                        if (d.type === 'message' && d.username !== myUsername && document.hidden) {
                            showNotification(d.username, d.content.substring(0, 50), d.avatar_url);
                        }
                        if (d.type === 'mention' && d.from !== myUsername) {
                            showNotification('–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç ' + d.from, d.content);
                        }
                    } catch(e) {}
                };
            }
            window.sendReaction = function(id, emoji) { if(ws) ws.send(JSON.stringify({ type: "reaction", message_id: id, emoji: emoji })); }
            window.toggleSpyMode = function() { isSpyMode = !isSpyMode; document.getElementById("spy-btn").classList.toggle("active"); document.querySelector(".input-wrapper").classList.toggle("spy-active"); }
            window.startReply = function(id, username) { replyToId = id; document.getElementById("reply-bar").style.display = "flex"; document.getElementById("reply-username").innerText = username; document.getElementById("messageText").focus(); }
            window.cancelReply = function() { replyToId = null; document.getElementById("reply-bar").style.display = "none"; }
            window.toggleAudio = function(id) { var a=document.getElementById('audio-'+id); var btn=a.parentElement.querySelector('.play-icon'); if(a.paused){a.play();btn.innerText="‚è∏";}else{a.pause();btn.innerText="‚ñ∂";} };
            window.updateAudioProgress = function(id) { var a=document.getElementById('audio-'+id); if(a.duration) document.getElementById('prog-'+id).style.width=((a.currentTime/a.duration)*100)+'%'; };
            window.setAudioDuration = function(id) { var a=document.getElementById('audio-'+id); if(a.duration) { var m=Math.floor(a.duration/60), s=Math.floor(a.duration%60); document.getElementById('time-'+id).innerText=m+':'+(s<10?'0'+s:s); } };
            window.seekAudio = function(e,id){ var a=document.getElementById('audio-'+id); var c=e.currentTarget; var p=(e.offsetX/c.clientWidth); a.currentTime=p*a.duration; };
            window.resetAudio = function(id){ document.getElementById('audio-'+id).parentElement.querySelector('.play-icon').innerText="‚ñ∂"; document.getElementById('prog-'+id).style.width='0%'; };

            // --- –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø (–∏–∫–æ–Ω–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞) ---
            async function toggleMic() {
                const micBtn = document.getElementById("mic-btn");
                if (!isRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        audioChunks = [];
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = e => {
                            if (e.data.size > 0) audioChunks.push(e.data);
                        };
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: "audio/webm" });
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                const base64Audio = reader.result; // data:audio/webm;...
                                if (ws && currentChannel && username) {
                                    ws.send(JSON.stringify({
                                        type: "message",
                                        channel: currentChannel,
                                        username: username,
                                        content: base64Audio,
                                        reply_to: replyToId,
                                        timer: isSpyMode ? 10 : 0
                                    }));
                                    cancelReply();
                                    if (isSpyMode) toggleSpyMode();
                                }
                            };
                            reader.readAsDataURL(blob);
                        };
                        mediaRecorder.start();
                        isRecording = true;
                        if (micBtn) micBtn.classList.add("recording");
                    } catch (e) {
                        alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
                    }
                } else {
                    isRecording = false;
                    if (mediaRecorder && mediaRecorder.state !== "inactive") {
                        mediaRecorder.stop();
                    }
                    if (micBtn) micBtn.classList.remove("recording");
                }
            }
            function handleFileSelect(i) { if(i.files[0]) { var r=new FileReader(); let file = i.files[0]; r.onload=e=> { let content = e.target.result; if (!file.type.startsWith("image/") && !file.type.startsWith("audio/")) { content = `[FILE:${file.name}]${content}`; } ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:content})); }; r.readAsDataURL(file); i.value=''; } }
            document.getElementById("messageText").addEventListener("keydown", function(e) { if(e.key === "Escape") { cancelReply(); } });
            function sendMessage(e) { e.preventDefault(); var i=document.getElementById("messageText"); if(!i.value.trim()) return; if (editingMessageId) { ws.send(JSON.stringify({type: "edit_message", message_id: editingMessageId, new_content: i.value, channel: currentChannel })); cancelEdit(); } else { ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:i.value,reply_to: replyToId,timer: isSpyMode ? 10 : 0})); i.value=''; cancelReply(); if(isSpyMode) toggleSpyMode(); } }
            window.startEdit = function(id, btn) { let row = document.getElementById("msg-" + id); let textSpan = row.querySelector(".content-text"); if(!textSpan) return; editingMessageId = id; let input = document.getElementById("messageText"); input.value = textSpan.innerText; input.focus(); document.getElementById("input-box").classList.add("editing"); document.getElementById("edit-indicator").style.display = "block"; };
            window.cancelEdit = function() { editingMessageId = null; document.getElementById("messageText").value = ""; document.getElementById("input-box").classList.remove("editing"); document.getElementById("edit-indicator").style.display = "none"; }
            let lastTypingTime = 0; document.getElementById("messageText").addEventListener("input", () => { let now = Date.now(); if (now - lastTypingTime > 2000 && ws && currentChannel) { ws.send(JSON.stringify({type: "typing", channel: currentChannel, username: username})); lastTypingTime = now; } });
            function requestHistory() { if(ws&&ws.readyState===1) { ws.send(JSON.stringify({type:"history",channel:currentChannel})); loadPinnedMessages(); } }
            function delMsg(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) ws.send(JSON.stringify({type:"delete", message_id:id})); }
            
            // --- –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ---
            async function loadPinnedMessages() {
                if (!currentChannel) return;
                try {
                    let r = await fetch(`/get_pinned?channel=${currentChannel}`);
                    let pinned = await r.json();
                    let bar = document.getElementById("pinned-bar");
                    if (!bar) {
                        bar = document.createElement("div");
                        bar.id = "pinned-bar";
                        bar.className = "pinned-messages-bar";
                        document.getElementById("messages").insertBefore(bar, document.getElementById("messages").firstChild);
                    }
                    if (pinned.length === 0) {
                        bar.style.display = "none";
                        return;
                    }
                    bar.style.display = "block";
                    bar.innerHTML = `<div class="pinned-title">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (${pinned.length})</div>`;
                    pinned.forEach(p => {
                        let item = document.createElement("div");
                        item.className = "pinned-item";
                        item.innerHTML = `<b>${p.username}</b>: ${p.content.substring(0, 50)}${p.content.length > 50 ? "..." : ""}`;
                        item.onclick = () => {
                            document.getElementById("messages").scrollTop = 0;
                            setTimeout(() => {
                                let msgEl = document.getElementById("msg-" + p.message_id);
                                if (msgEl) {
                                    msgEl.scrollIntoView({ behavior: "smooth", block: "center" });
                                    msgEl.style.background = "rgba(0, 242, 96, 0.2)";
                                    setTimeout(() => msgEl.style.background = "", 2000);
                                }
                            }, 100);
                        };
                        bar.appendChild(item);
                    });
                } catch(e) { console.error(e); }
            }
            
            async function togglePin(msgId) {
                let row = document.getElementById("msg-" + msgId);
                if (!row) return;
                let isPinned = row.querySelector(".pinned-indicator") !== null;
                if (isPinned) {
                    let r = await fetch("/unpin_message", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:msgId})});
                    if (r.ok) { loadPinnedMessages(); requestHistory(); }
                } else {
                    let r = await fetch("/pin_message", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:msgId,channel:currentChannel,username:username})});
                    if (r.ok) { loadPinnedMessages(); requestHistory(); }
                }
            }
            
            // --- –ü–ï–†–ï–°–´–õ–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ---
            window.forwardMessage = async function(msgId) {
                let targetChannel = prompt("–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏:");
                if (!targetChannel) return;
                try {
                    let r = await fetch("/forward_message", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:msgId,target_channel:targetChannel,username:username})});
                    if (r.ok) alert("–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ!");
                    else alert("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏");
                } catch(e) { alert("–û—à–∏–±–∫–∞"); }
            }
            async function loadDMs() { let r=await fetch("/get_dms?username="+username); let d=await r.json(); document.getElementById("dm-list").innerHTML=""; d.forEach(u => { let name = u === "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" ? "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (Saved)" : u; let div=document.createElement("div"); div.className="channel"; div.innerHTML=`<img src="${getDefaultAvatar(u)}" class="dm-avatar"><span style="flex-grow:1">${name}<span id="status-${u}" class="status-dot"></span></span>`; let chatID = u === "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" ? "dm_"+username+"_"+username : "dm_"+[username,u].sort().join("_"); div.onclick=(ev)=>switchChat(chatID, name, true, null, ev); document.getElementById("dm-list").appendChild(div); }); }
            async function loadGroups() { let r=await fetch("/get_my_groups?username="+username); let d=await r.json(); document.getElementById("groups-list").innerHTML=""; d.forEach(g => { let div=document.createElement("div"); div.className="channel"; div.innerText=g.name; div.onclick=(ev)=>switchChat("group_"+g.id, g.name, false, g.id, ev); document.getElementById("groups-list").appendChild(div); }); }
            async function loadRequests() { let r=await fetch("/get_requests?username="+username); let d=await r.json(); document.getElementById("requests-list").innerHTML=""; document.getElementById("requests-section").style.display=d.length?"block":"none"; d.forEach(q => { let div=document.createElement("div"); div.className="channel"; div.style.cursor="default"; div.innerHTML=`${q.sender} <span class="icon-btn" onclick="respondReq(${q.id},'accept')" style="margin-left:auto">‚úÖ</span><span class="icon-btn" onclick="respondReq(${q.id},'reject')">‚ùå</span>`; document.getElementById("requests-list").appendChild(div); }); }
            function switchChat(id, name, isDm, gid, ev) { currentChannel=id; currentGroupId=gid; document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active')); if(ev && ev.currentTarget){ev.currentTarget.classList.add('active');} document.getElementById("header-title").innerText=name; document.getElementById("add-member-btn").style.display=gid?"block":"none"; document.getElementById("call-btn").style.display=isDm?"flex":"none"; document.getElementById("messages").innerHTML=""; requestHistory(); closeSidebarOnMobile(); if(gid) loadVoiceChannels(gid); }
            async function sendFriendRequest() { var u=document.getElementById("dm-username").value; if(u) fetch("/send_request", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender:username,receiver:u})}).then(r=>{if(r.ok){alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");document.getElementById("dm-modal").style.display="none";}else alert("–û—à–∏–±–∫–∞")}); }
            async function createGroup() { var n=document.getElementById("group-name-input").value; if(n) fetch("/create_group", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,owner:username})}).then(r=>{if(r.ok){document.getElementById("create-group-modal").style.display="none";loadGroups();}}); }
            async function addMemberToGroup() { var u=document.getElementById("new-member-username").value; if(u) fetch("/add_member", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group_id:currentGroupId,username:u})}).then(r=>{if(r.ok){alert("–î–æ–±–∞–≤–ª–µ–Ω");document.getElementById("add-member-modal").style.display="none";}else alert("–û—à–∏–±–∫–∞")}); }
            async function respondReq(id, act) { fetch("/respond_request", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:id,action:act})}).then(r=>{if(r.ok){loadRequests();if(act==='accept')loadDMs();}}); }

            // --- –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø –î–†–£–ì–ò–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–£–õ–£–ß–®–ï–ù–ù–´–ô –í –°–¢–ò–õ–ï TELEGRAM) ---
            window.openUserProfile = async function(name) {
                try {
                    const r = await fetch("/get_profile?username=" + encodeURIComponent(name));
                    if (!r.ok) {
                        alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                        return;
                    }
                    const u = await r.json();
                    document.getElementById("view-avatar").src = u.avatar_url || getDefaultAvatar(u.username);
                    document.getElementById("view-username").innerHTML = `<div style="display:flex;align-items:center;gap:10px;justify-content:center;"><span>${u.username}</span>${u.is_admin ? '<span style="font-size:20px;">üëë</span>' : ''}</div>`;
                    document.getElementById("view-bio").innerText = u.bio || "–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞";
                    let details = `<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--glass-border);">`;
                    if (u.user_id) details += `<div style="margin-bottom:12px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:11px;opacity:0.7;margin-bottom:4px;">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div><div style="font-weight:600;font-family:monospace;">${u.user_id}</div></div>`;
                    if (u.real_name) details += `<div style="margin-bottom:8px;"><span style="opacity:0.7;font-size:13px;">–ò–º—è:</span> <span style="font-weight:500;">${u.real_name}</span></div>`;
                    if (u.location) details += `<div style="margin-bottom:8px;"><span style="opacity:0.7;font-size:13px;">–ì–æ—Ä–æ–¥:</span> <span style="font-weight:500;">${u.location}</span></div>`;
                    if (u.birth_date) details += `<div style="margin-bottom:8px;"><span style="opacity:0.7;font-size:13px;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</span> <span style="font-weight:500;">${u.birth_date}</span></div>`;
                    if (u.phone) details += `<div style="margin-bottom:8px;"><span style="opacity:0.7;font-size:13px;">–¢–µ–ª–µ—Ñ–æ–Ω:</span> <span style="font-weight:500;">${u.phone}</span></div>`;
                    if (u.email) details += `<div style="margin-bottom:8px;"><span style="opacity:0.7;font-size:13px;">Email:</span> <span style="font-weight:500;">${u.email}</span></div>`;
                    if (u.social_link) details += `<div style="margin-bottom:8px;"><span style="opacity:0.7;font-size:13px;">–°–æ—Ü—Å–µ—Ç–∏:</span> <a href="${u.social_link}" target="_blank" style="color:var(--accent-primary);text-decoration:none;">${u.social_link}</a></div>`;
                    details += `</div>`;
                    if (!u.user_id && !u.real_name && !u.location && !u.birth_date && !u.phone && !u.email && !u.social_link) details = "<div style='opacity:0.6;margin-top:20px;padding-top:20px;border-top:1px solid var(--glass-border);'>–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>";
                    document.getElementById("view-details").innerHTML = details;
                    document.getElementById("user-profile-modal").style.display = "flex";
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è");
                }
            }

            // --- –ó–í–û–ù–ö–ò (WebRTC) ---
            function showCallUI(name, status, isIncoming) {
                document.getElementById("call-overlay").style.display="flex";
                document.getElementById("call-username").innerText=name;
                document.getElementById("call-avatar").src=getDefaultAvatar(name);
                document.getElementById("call-status").innerText=status;
                document.getElementById("answer-btn").style.display=isIncoming?"flex":"none";
            }

            function hangUp() {
                if(ws && callTarget) ws.send(JSON.stringify({type:"hang_up", target:callTarget}));
                closeCall();
            }

            function closeCall() {
                document.getElementById("call-overlay").style.display="none";
                if(peerConnection) { peerConnection.close(); peerConnection=null; }
                if(localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
                ringtone.pause(); ringtone.currentTime=0;
                callTarget = null;
                pendingOffer = null;
            }

            function getCurrentDmTarget() {
                if (!currentChannel || !currentChannel.startsWith("dm_")) return null;
                const parts = currentChannel.replace("dm_","").split("_");
                if (parts.length !== 2) return null;
                const [u1, u2] = parts;
                return u1 === username ? u2 : u1;
            }

            async function startCall() {
                const target = getCurrentDmTarget();
                if (!target) {
                    alert("–ó–≤–æ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö");
                    return;
                }
                callTarget = target;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (e) {
                    alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
                    return;
                }
                setupPeerConnection();
                localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                if (ws) {
                    ws.send(JSON.stringify({
                        type: "call_offer",
                        target: callTarget,
                        sender: username,
                        sdp: offer
                    }));
                }
                ringtone.currentTime = 0;
                ringtone.play().catch(()=>{});
                showCallUI(callTarget, "–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...", false);
            }

            function setupPeerConnection() {
                peerConnection = new RTCPeerConnection(rtcConfig);
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && ws && callTarget) {
                        ws.send(JSON.stringify({
                            type: "new_ice_candidate",
                            target: callTarget,
                            sender: username,
                            candidate: event.candidate
                        }));
                    }
                };
                peerConnection.ontrack = (event) => {
                    const remoteAudio = document.getElementById("remote-audio");
                    if (remoteAudio) {
                        remoteAudio.srcObject = event.streams[0];
                    }
                };
            }

            async function handleOffer(data) {
                callTarget = data.sender;
                pendingOffer = data.sdp;
                ringtone.currentTime = 0;
                ringtone.play().catch(()=>{});
                showCallUI(callTarget, "–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...", true);
            }

            async function answerCall() {
                if (!pendingOffer) {
                    closeCall();
                    return;
                }
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (e) {
                    alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
                    closeCall();
                    return;
                }
                setupPeerConnection();
                localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

                await peerConnection.setRemoteDescription(new RTCSessionDescription(pendingOffer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                if (ws && callTarget) {
                    ws.send(JSON.stringify({
                        type: "call_answer",
                        target: callTarget,
                        sender: username,
                        sdp: answer
                    }));
                }
                ringtone.pause();
                ringtone.currentTime = 0;
                showCallUI(callTarget, "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...", false);
            }

            async function handleAnswer(data) {
                if (!peerConnection) return;
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    document.getElementById("call-status").innerText = "–í —Å–µ—Ç–∏";
                    ringtone.pause();
                    ringtone.currentTime = 0;
                } catch (e) {
                    console.error(e);
                }
            }

            async function handleCandidate(data) {
                if (!peerConnection || !data.candidate) return;
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (e) {
                    console.error(e);
                }
            }
            
            // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –¢–ï–ú–´, –°–¢–ê–¢–£–°–´, –ü–†–ï–í–¨–Æ, –ì–û–õ–û–°–û–í–´–ï –ö–ê–ù–ê–õ–´ ---
            
            // –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø
            window.changeTheme = async function(theme) {
                document.body.className = theme + '-theme';
                document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                if (username) {
                    await fetch("/update_theme", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username,theme:theme})});
                    localStorage.setItem('flux_theme', theme);
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            window.addEventListener('DOMContentLoaded', () => {
                let savedTheme = localStorage.getItem('flux_theme') || 'dark';
                document.body.className = savedTheme + '-theme';
            });
            
            // –°–¢–ê–¢–£–°–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
            window.updateUserStatus = async function(status) {
                let customStatus = document.getElementById("settings-custom-status")?.value || null;
                await fetch("/update_status", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username,status:status,custom_status:customStatus})});
                alert("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!");
            }
            
            // –ü–†–ï–í–¨–Æ –°–°–´–õ–û–ö - —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ addMsg –≤—ã—à–µ
            
            // –ì–û–õ–û–°–û–í–´–ï –ö–ê–ù–ê–õ–´
            async function loadVoiceChannels(groupId) {
                if (!groupId) return;
                try {
                    let r = await fetch(`/get_voice_channels?group_id=${groupId}`);
                    let channels = await r.json();
                    let container = document.getElementById("voice-channels-list");
                    if (!container) {
                        container = document.createElement("div");
                        container.id = "voice-channels-list";
                        container.innerHTML = '<div class="sidebar-title">–ì–û–õ–û–°–û–í–´–ï –ö–ê–ù–ê–õ–´</div>';
                        document.getElementById("groups-list").parentElement.insertBefore(container, document.getElementById("groups-list"));
                    }
                    container.innerHTML = '<div class="sidebar-title">üîä –ì–û–õ–û–°–û–í–´–ï</div>';
                    channels.forEach(vc => {
                        let div = document.createElement("div");
                        div.className = "voice-channel";
                        div.innerHTML = `<span class="voice-icon">üîä</span>${vc.name}<span class="voice-members-count">${vc.members}</span>`;
                        div.onclick = () => joinVoiceChannel(vc.id);
                        container.appendChild(div);
                    });
                } catch(e) { console.error(e); }
            }
            
            async function joinVoiceChannel(channelId) {
                await fetch("/join_voice", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channel_id:channelId,username:username})});
                alert("–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É!");
            }
            
            // –†–ê–°–®–ò–†–ï–ù–ù–´–ï –≠–ú–û–î–ó–ò - –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ input
            window.toggleEmojiPicker = function() {
                let picker = document.getElementById("emoji-picker");
                if (!picker) {
                    picker = document.createElement("div");
                    picker.id = "emoji-picker";
                    picker.className = "emoji-picker";
                    let emojis = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','üíØ','üéâ','üëè','üôå','üòç','ü§î','üò¥','ü§Æ','üí™','üéÆ','üéµ','üé¨','üì∑','üì±','üíª','üöÄ','‚≠ê','‚ú®','üíé','üéØ','üèÜ','üéä','üéà','üéÅ'];
                    let grid = document.createElement("div");
                    grid.className = "emoji-grid";
                    emojis.forEach(emoji => {
                        let item = document.createElement("div");
                        item.className = "emoji-item";
                        item.innerText = emoji;
                        item.onclick = () => {
                            document.getElementById("messageText").value += emoji;
                            picker.classList.remove("show");
                        };
                        grid.appendChild(item);
                    });
                    picker.appendChild(grid);
                    document.querySelector(".input-wrapper").appendChild(picker);
                }
                picker.classList.toggle("show");
            }
            
            // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–¢–ò–ö–ï–†–û–í
            let currentStickerPack = null;
            window.toggleStickerPicker = async function() {
                let picker = document.getElementById("sticker-picker");
                if (!picker) {
                    picker = document.createElement("div");
                    picker.id = "sticker-picker";
                    picker.className = "sticker-picker";
                    document.querySelector(".input-wrapper").appendChild(picker);
                }
                
                if (picker.classList.contains("show")) {
                    picker.classList.remove("show");
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤
                try {
                    const packs = await fetch(`/get_sticker_packs?username=${username}`).then(r => r.json());
                    if (packs.length === 0) {
                        picker.innerHTML = "<div style='padding:20px;text-align:center;opacity:0.7;'>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –Ω–∞–±–æ—Ä —á–µ—Ä–µ–∑ API.</div>";
                        picker.classList.add("show");
                        return;
                    }
                    
                    let html = '<div class="sticker-pack-tabs">';
                    packs.forEach((pack, i) => {
                        html += `<div class="sticker-pack-tab ${i === 0 ? 'active' : ''}" onclick="loadStickers('${pack.name}', this)">${pack.title || pack.name}</div>`;
                    });
                    html += '</div><div class="sticker-grid" id="sticker-grid"></div>';
                    picker.innerHTML = html;
                    
                    if (packs.length > 0) {
                        currentStickerPack = packs[0].name;
                        loadStickers(packs[0].name);
                    }
                } catch(e) {
                    picker.innerHTML = "<div style='padding:20px;text-align:center;opacity:0.7;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤</div>";
                }
                
                picker.classList.add("show");
            }
            
            window.loadStickers = async function(packName, tabEl) {
                currentStickerPack = packName;
                if (tabEl) {
                    document.querySelectorAll(".sticker-pack-tab").forEach(t => t.classList.remove("active"));
                    tabEl.classList.add("active");
                }
                
                try {
                    const stickers = await fetch(`/get_stickers?pack_name=${packName}`).then(r => r.json());
                    const grid = document.getElementById("sticker-grid");
                    if (!grid) return;
                    
                    grid.innerHTML = stickers.map(s => 
                        `<div class="sticker-item" onclick="sendSticker('${s.sticker_data.replace(/'/g, "\\'")}')">
                            <img src="${s.sticker_data}" alt="${s.name}" onerror="this.parentElement.style.display='none'">
                        </div>`
                    ).join('');
                } catch(e) {
                    console.error("Error loading stickers:", e);
                }
            }
            
            window.sendSticker = function(stickerData) {
                if (ws && currentChannel) {
                    ws.send(JSON.stringify({
                        type: "message",
                        channel: currentChannel,
                        username: username,
                        content: stickerData
                    }));
                    document.getElementById("sticker-picker").classList.remove("show");
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —ç–º–æ–¥–∑–∏ –∏ —Å—Ç–∏–∫–µ—Ä–æ–≤ –≤ input
            setTimeout(() => {
                let inputWrapper = document.querySelector(".input-wrapper");
                if (inputWrapper) {
                    if (!document.getElementById("emoji-btn")) {
                        let emojiBtn = document.createElement("div");
                        emojiBtn.id = "emoji-btn";
                        emojiBtn.className = "icon-btn-input";
                        emojiBtn.innerHTML = "üòÄ";
                        emojiBtn.onclick = toggleEmojiPicker;
                        emojiBtn.title = "–≠–º–æ–¥–∑–∏";
                        inputWrapper.insertBefore(emojiBtn, inputWrapper.querySelector("#messageText"));
                    }
                    if (!document.getElementById("sticker-btn")) {
                        let stickerBtn = document.createElement("div");
                        stickerBtn.id = "sticker-btn";
                        stickerBtn.className = "icon-btn-input";
                        stickerBtn.innerHTML = "üé≠";
                        stickerBtn.onclick = toggleStickerPicker;
                        stickerBtn.title = "–°—Ç–∏–∫–µ—Ä—ã";
                        inputWrapper.insertBefore(stickerBtn, inputWrapper.querySelector("#messageText"));
                    }
                }
            }, 1000);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
            if (typeof ws !== 'undefined' && ws) {
                ws.addEventListener('message', (e) => {
                    try {
                        let d = JSON.parse(e.data);
                        if (d.type === "voice_channel_created" || d.type === "voice_joined" || d.type === "voice_left") {
                            if (currentGroupId) loadVoiceChannels(currentGroupId);
                        }
                        if (d.type === "status_update") {
                            updateStatus(d.username, d.status);
                        }
                        if (d.type === "message_theme_changed") {
                            let msgEl = document.getElementById('msg-' + d.message_id);
                            if (msgEl) {
                                let bubble = msgEl.querySelector('.msg-bubble');
                                if (bubble) {
                                    bubble.classList.remove('theme-blue', 'theme-purple', 'theme-green', 'theme-red', 'theme-orange');
                                    if (d.theme) bubble.classList.add('theme-' + d.theme);
                                }
                            }
                        }
                    } catch(e) {}
                });
            }
        </script>
    </body>
</html>
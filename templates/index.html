<!DOCTYPE html>
<html>
    <head>
        <title>Flux</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        
        <link rel="manifest" href="/static/manifest.json">
        <link rel="icon" type="image/png" href="/static/icon.png">
        <link rel="apple-touch-icon" href="/static/icon.png">
        <meta name="theme-color" content="#0f0c29">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;800&display=swap" rel="stylesheet">
        <style>
            :root { --bg-deep:#0f0c29; --bg-medium:#1a163a; --bg-light:#302b63; --accent-primary:#00d2ff; --accent-secondary:#3a7bd5; --text-main:#ffffff; --text-dim:#b8b8d0; --danger:#ff416c; --success:#00f260; --glass:rgba(255,255,255,0.05); --glass-border:rgba(255,255,255,0.1); }
            * { box-sizing: border-box; }
            body { background: linear-gradient(135deg, var(--bg-deep), #24243e); color: var(--text-main); font-family: 'Exo 2', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
            
            /* –ò–∫–æ–Ω–∫–∏ */
            .icon { width: 20px; height: 20px; fill: currentColor; vertical-align: middle; }
            .icon-btn { cursor: pointer; color: var(--text-dim); display: inline-flex; align-items: center; justify-content: center; padding: 5px; border-radius: 5px; }
            .icon-btn:hover { color: var(--accent-primary); background: var(--glass); }
            .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; margin-left: 6px; box-shadow: 0 0 5px var(--success); display: none; vertical-align: middle;}

            /* –°–∞–π–¥–±–∞—Ä (–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) */
            .sidebar { width: 260px; background: rgba(15, 12, 41, 0.98); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; transition: transform 0.3s ease; }
            .sidebar-title { font-weight: 800; padding: 20px 15px 10px 15px; color: var(--text-dim); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
            .channel { padding: 10px 12px; margin: 2px 10px; border-radius: 10px; cursor: pointer; color: var(--text-dim); font-weight: 600; display: flex; align-items: center; transition: 0.2s; font-size: 14px; }
            .channel:hover { background: var(--glass); color: white; }
            .channel.active { background: linear-gradient(90deg, rgba(0, 210, 255, 0.1), transparent); color: white; border-left: 3px solid var(--accent-primary); }
            .dm-avatar { width: 32px; height: 32px; min-width: 32px; border-radius: 50%; margin-right: 10px; background: linear-gradient(135deg, #667eea, #764ba2); object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
            
            /* –ü—Ä–æ—Ñ–∏–ª—å —é–∑–µ—Ä–∞ (–≤–Ω–∏–∑—É) */
            .user-panel { background: rgba(0,0,0,0.3); padding: 12px 15px; display: flex; align-items: center; cursor: pointer; margin-top: auto; border-top: 1px solid var(--glass-border); position: relative; z-index: 50; }
            .my-avatar { width: 38px; height: 38px; min-width: 38px; border-radius: 50%; background-color: #5865f2; margin-right: 10px; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); }
            .my-info { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
            .my-name { font-weight: bold; font-size: 14px; color: white; line-height: 1.2; display: flex; align-items: center;}
            .my-bio { font-size: 11px; color: var(--accent-primary); opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}

            /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
            .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: radial-gradient(circle at top right, #1a163a 0%, #0f0c29 60%); min-width: 0; width: 100%; position: relative; }
            .chat-header { height: 60px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; padding: 0 15px; font-weight: 800; color: white; flex-shrink: 0; font-size: 16px; letter-spacing: 0.5px; background: rgba(15, 12, 41, 0.8); backdrop-filter: blur(10px); z-index: 10; justify-content: space-between; }
            .header-left { display: flex; align-items: center; overflow: hidden; }
            .hamburger { display: none; margin-right: 15px; font-size: 24px; cursor: pointer; color: white; }
            
            /* –ö–Ω–æ–ø–∫–∏ –≤ —Ö–µ–¥–µ—Ä–µ */
            .header-actions { display: flex; gap: 10px; align-items: center; }
            .add-member-header-btn { cursor: pointer; background: linear-gradient(90deg, var(--success), #00b09b); color: #0f0c29; font-weight: 800; padding: 6px 12px; border-radius: 20px; font-size: 12px; display: none; box-shadow: 0 0 10px rgba(0, 242, 96, 0.2); white-space: nowrap;}
            .call-btn { cursor: pointer; color: var(--success); display: none; padding: 8px; border-radius: 50%; border: 2px solid var(--success); width: 36px; height: 36px; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 0 10px rgba(0, 242, 96, 0.3); }
            .call-btn:hover { background: var(--success); color: #0f0c29; box-shadow: 0 0 20px rgba(0, 242, 96, 0.6); }

            /* –°–æ–æ–±—â–µ–Ω–∏—è */
            #messages { list-style-type: none; margin: 0; padding: 15px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
            .msg-row { display: flex; width: 100%; align-items: flex-end; }
            .msg-row.other { justify-content: flex-start; }
            .msg-row.me { justify-content: flex-end; }
            .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 18px; position: relative; word-wrap: break-word; font-size: 15px; }
            .msg-row.other .msg-bubble { background: rgba(255, 255, 255, 0.08); border: 1px solid var(--glass-border); border-bottom-left-radius: 4px; margin-left: 8px; }
            .msg-row.me .msg-bubble { background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); color: #0f0c29; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2); }
            .msg-row.me .avatar, .msg-row.me .username { display: none; }
            .msg-row.me .timestamp { color: rgba(15, 12, 41, 0.6); }
            .avatar { width: 32px; height: 32px; border-radius: 50%; background-color: #5865f2; flex-shrink: 0; object-fit: cover; margin-bottom: 2px;}
            .username { font-weight: 700; font-size: 12px; color: var(--accent-primary); margin-bottom: 2px; display: block; }
            .timestamp { font-size: 9px; color: var(--text-dim); margin-left: 8px; float: right; margin-top: 4px;}
            
            /* –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π */
            .audio-player { display: flex; align-items: center; gap: 10px; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 12px; margin-top: 5px; min-width: 180px; }
            .play-btn { width: 30px; height: 30px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--accent-primary); flex-shrink: 0; }
            
            /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
            form { padding: 10px 15px 20px 15px; margin: 0; width: 100%; flex-shrink: 0; background: transparent; }
            .input-wrapper { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 20px; display: flex; align-items: center; padding: 5px 10px; width: 100%; backdrop-filter: blur(5px); }
            input[type="text"] { flex-grow: 1; padding: 10px; border: none; background: transparent; color: white; outline: none; font-size: 16px; width: 100%; font-family: 'Exo 2', sans-serif;}
            .file-btn, .mic-btn { cursor: pointer; color: var(--text-dim); padding: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
            .mic-btn.recording { color: var(--danger); animation: pulse 1s infinite; }

            /* –≠–ö–†–ê–ù –ó–í–û–ù–ö–ê (CALL OVERLAY) */
            #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
            .call-avatar { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--accent-primary); box-shadow: 0 0 50px var(--accent-primary); margin-bottom: 30px; object-fit: cover; animation: pulse 2s infinite; }
            .call-username { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: white; }
            .call-status { font-size: 16px; margin-bottom: 40px; color: var(--text-dim); text-align: center; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 15px; }
            .call-actions { display: flex; gap: 40px; }
            .call-action-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
            .btn-answer { background: var(--success); color: white; box-shadow: 0 0 25px rgba(0, 242, 96, 0.5); }
            .btn-hangup { background: var(--danger); color: white; box-shadow: 0 0 25px rgba(255, 65, 108, 0.5); }
            .btn-answer:hover, .btn-hangup:hover { transform: scale(1.1); }

            /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ –ú–æ–¥–∞–ª–∫–∏ */
            @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
            .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
            .modal-content { background: #1a163a; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; position: relative; border: 1px solid var(--glass-border); box-shadow: 0 20px 60px rgba(0,0,0,0.6); color: white; }
            .close-btn { position: absolute; top: 15px; right: 20px; color: var(--text-dim); font-size: 24px; cursor: pointer; }
            .settings-input, .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 10px; outline: none; font-size: 16px; font-family: 'Exo 2';}
            .profile-preview { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; object-fit: cover; border: 3px solid var(--accent-primary); }
            .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; font-size: 16px; text-transform: uppercase; margin-bottom: 10px;}
            .btn-login { background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); }
            .btn-register { background: transparent; border: 1px solid var(--glass-border); }

            /* –õ–æ–≥–∏–Ω —Å–∫—Ä–∏–Ω */
            #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #0f0c29; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center;}
            .logo-f { font-size: 100px; font-weight: 900; background: linear-gradient(to bottom, #00ffff, #0055ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 25px rgba(0, 210, 255, 0.7)); }
            .login-box { width: 85%; max-width: 350px; text-align: center; }

            /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
            @media (max-width: 768px) {
                .sidebar { position: absolute; z-index: 100; height: 100%; width: 280px; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.8); }
                .sidebar.open { transform: translateX(0); }
                .hamburger { display: block; } 
                #overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; backdrop-filter: blur(2px); }
                #overlay.show { display: block; }
                .msg-bubble { max-width: 85%; }
                /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–∞ –Ω–∞ –∞–π—Ñ–æ–Ω–µ */
                input[type="text"], input[type="password"] { font-size: 16px !important; }
            }
        </style>
    </head>
    <body>
        <div id="image-modal" class="modal" onclick="this.style.display='none'"><span class="close-btn">&times;</span><img id="modal-img" style="max-width:100%;max-height:80vh;border-radius:10px;"></div>
        
        <div id="call-overlay">
            <img id="call-avatar" class="call-avatar" src="">
            <div id="call-username" class="call-username">–ò–º—è</div>
            <div id="call-status" class="call-status">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
            <div class="call-actions">
                <button id="answer-btn" class="call-action-btn btn-answer" onclick="answerCall()">üìû</button>
                <button id="hangup-btn" class="call-action-btn btn-hangup" onclick="hangUp()">‚ùå</button>
            </div>
            <audio id="remote-audio" autoplay playsinline></audio>
        </div>

        <div id="user-profile-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><img id="view-avatar" class="profile-preview" src=""><div id="view-username" style="font-size:22px;font-weight:bold;"></div><div id="view-bio" style="color:var(--text-dim);margin-bottom:15px;"></div><div id="view-details" style="text-align:left;font-size:14px;color:white;line-height:1.6;"></div></div></div>
        <div id="settings-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–ü—Ä–æ—Ñ–∏–ª—å</h2><img id="settings-avatar-preview" class="profile-preview" src=""><label class="btn btn-login" style="display:block;margin-bottom:15px;">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" style="display:none;" accept="image/*" onchange="previewAvatar(this)"></label><input id="settings-bio" class="settings-input" placeholder="–°—Ç–∞—Ç—É—Å"><input id="settings-realname" class="settings-input" placeholder="–ò–º—è"><input id="settings-location" class="settings-input" placeholder="–ì–æ—Ä–æ–¥"><input id="settings-birthdate" class="settings-input" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è"><input id="settings-social" class="settings-input" placeholder="–°–æ—Ü—Å–µ—Ç–∏"><button class="btn btn-login" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>
        <div id="dm-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞</h2><input id="dm-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º"><button class="btn btn-login" onclick="sendFriendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div></div>
        <div id="create-group-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2><input id="group-name-input" class="settings-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><button class="btn btn-login" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button></div></div>
        <div id="add-member-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–î–æ–±–∞–≤–∏—Ç—å</h2><input id="new-member-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º"><button class="btn btn-login" onclick="addMemberToGroup()">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>

        <div id="login-screen">
            <div class="logo-container"><div class="logo-f">F</div><div style="color:var(--accent-primary);letter-spacing:5px;">FLUX</div></div>
            <div class="login-box" style="margin-top:20px;">
                <input type="text" id="usernameInput" class="login-input" placeholder="–ù–∏–∫–Ω–µ–π–º" />
                <input type="password" id="passwordInput" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" />
                <div id="errorMsg" class="error-msg">–û—à–∏–±–∫–∞</div>
                <button class="btn btn-login" onclick="auth('login')">–í–æ–π—Ç–∏</button>
                <button class="btn btn-register" onclick="auth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>

        <div id="app-container">
            <div id="overlay" onclick="toggleSidebar()"></div>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-title">–ß–ê–¢–´ <span class="add-btn icon-btn" onclick="document.getElementById('create-group-modal').style.display='flex'">+</span></div><div id="groups-list"></div>
                <div class="sidebar-title">–õ–ò–ß–ù–´–ï <span class="add-btn icon-btn" onclick="document.getElementById('dm-modal').style.display='flex'">+</span></div><div id="dm-list"></div>
                <div id="requests-section" style="display:none;"><div class="sidebar-title" style="color:var(--success);">–ó–ê–Ø–í–ö–ò</div><div id="requests-list"></div></div>
                <div class="user-panel" onclick="openSettings()"><img id="my-avatar-img" class="my-avatar" src=""><div class="my-info"><div id="my-name-text" class="my-name"></div><div id="my-bio-text" class="my-bio"></div></div><div class="settings-btn">‚öôÔ∏è</div></div>
            </div>
            <div class="chat-area">
                <div class="chat-header">
                    <div class="header-left">
                        <span class="hamburger" onclick="toggleSidebar()">‚ò∞</span>
                        <span id="header-icon" style="margin-right:8px;color:var(--accent-primary);"></span>
                        <span id="header-title">Flux</span>
                    </div>
                    <div class="header-actions">
                        <span id="call-btn" class="call-btn" onclick="startCall()">üìû</span>
                        <span id="add-member-btn" class="add-member-header-btn" onclick="document.getElementById('add-member-modal').style.display='flex'">+–ß–µ–ª–æ–≤–µ–∫</span>
                    </div>
                </div>
                <ul id='messages'></ul><div id="typing-indicator"></div>
                <form action="" onsubmit="sendMessage(event)"><div class="input-wrapper"><label class="file-btn">+<input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(this)"></label><input type="text" id="messageText" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."/><div id="mic-btn" class="mic-btn" onclick="toggleMic()">üé§</div></div></form>
            </div>
        </div>

        <script>
            const ICONS = {crown:`<span style="color:gold;margin-left:4px">üëë</span>`, ban:`‚õî`, trash:`üóëÔ∏è`, check:`‚úÖ`, cross:`‚ùå`, play:`‚ñ∂`, pause:`‚è∏`};
            const notifSound = new Audio("https://cdn.freesound.org/previews/235/235911_2391840-lq.mp3");
            const ringtone = new Audio("https://cdn.freesound.org/previews/351/351239_1241198-lq.mp3"); ringtone.loop=true;
            var ws, username, currentUserAvatar, tempAvatarBase64, myIsAdmin, currentChannel, currentGroupId;
            var mediaRecorder, audioChunks=[], isRecording=false, typingTimeout, lastTypingSent=0;
            // WebRTC
            var localStream, peerConnection, callTarget, rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

            function getDefaultAvatar(n) { return `https://ui-avatars.com/api/?name=${n}&background=0f0c29&color=00d2ff&size=128&bold=true`; }
            function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("show"); }
            function closeSidebarOnMobile() { if(window.innerWidth<=768) toggleSidebar(); }
            function openSettings() { document.getElementById("settings-modal").style.display='flex'; document.getElementById("settings-avatar-preview").src=currentUserAvatar; document.getElementById("settings-bio").value=document.getElementById("my-bio-text").innerText; }

            async function auth(type) {
                var u = document.getElementById("usernameInput").value, p = document.getElementById("passwordInput").value;
                if(!u||!p)return;
                try {
                    let r = await fetch("/"+type, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
                    if(r.ok) {
                        let d = await r.json(); username=u; myIsAdmin=d.is_admin;
                        updateMyUI(d); loadDMs(); loadGroups(); loadRequests();
                        document.getElementById("login-screen").style.display="none"; document.getElementById("app-container").style.display="flex";
                        connectWS();
                        ['realname','location','birthdate','social'].forEach(k => document.getElementById("settings-"+k).value=d[k=="realname"?"real_name":k=="social"?"social_link":k]||"");
                    } else document.getElementById("errorMsg").style.display="block";
                } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            }
            function updateMyUI(d) {
                currentUserAvatar = d.avatar_url && !d.avatar_url.includes("discord") ? d.avatar_url : getDefaultAvatar(username);
                document.getElementById("my-name-text").innerHTML = username + (d.is_admin?ICONS.crown:"");
                document.getElementById("my-bio-text").innerText = d.bio || "Online";
                document.getElementById("my-avatar-img").src = currentUserAvatar;
            }

            // --- WEBRTC –õ–û–ì–ò–ö–ê ---
            async function startCall() {
                if(!currentChannel.startsWith("dm_")) return;
                callTarget = document.getElementById("header-title").innerText;
                showCallUI(callTarget, "–ù–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞...", false);
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
                    createPeer();
                    localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    ws.send(JSON.stringify({type:"call_offer", target:callTarget, sender:username, offer:offer}));
                } catch(e) { alert("–ù—É–∂–µ–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω!"); closeCall(); }
            }
            async function handleOffer(d) {
                callTarget = d.sender;
                showCallUI(callTarget, "–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!", true);
                window.incomingOffer = d.offer;
                ringtone.play().catch(e=>{});
            }
            async function answerCall() {
                ringtone.pause();
                document.getElementById("answer-btn").style.display="none";
                document.getElementById("call-status").innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
                    createPeer();
                    localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(window.incomingOffer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    ws.send(JSON.stringify({type:"call_answer", target:callTarget, answer:answer}));
                } catch(e) { alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞"); hangUp(); }
            }
            async function handleAnswer(d) { await peerConnection.setRemoteDescription(new RTCSessionDescription(d.answer)); }
            async function handleCandidate(d) { if(peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(d.candidate)); }
            
            function createPeer() {
                peerConnection = new RTCPeerConnection(rtcConfig);
                peerConnection.oniceconnectionstatechange = () => {
                    let s = peerConnection.iceConnectionState;
                    let txt = "";
                    if(s==="checking") txt="üîÑ –ü–æ–∏—Å–∫ –ø—É—Ç–∏...";
                    if(s==="connected") txt="üü¢ –°–í–Ø–ó–¨ –ï–°–¢–¨! –ì–æ–≤–æ—Ä–∏—Ç–µ";
                    if(s==="disconnected") txt="üî¥ –†–∞–∑—Ä—ã–≤";
                    if(s==="failed") txt="üî¥ –û—à–∏–±–∫–∞ NAT (–ù—É–∂–µ–Ω WiFi)";
                    if(txt) document.getElementById("call-status").innerText = txt;
                };
                peerConnection.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({type:"new_ice_candidate", target:callTarget, candidate:e.candidate})); };
                peerConnection.ontrack = e => {
                    const ra = document.getElementById("remote-audio");
                    ra.srcObject = e.streams[0];
                    ra.play().catch(e=>console.log("Auto-play blocked"));
                };
            }
            function showCallUI(name, status, isIncoming) {
                document.getElementById("call-overlay").style.display="flex";
                document.getElementById("call-username").innerText=name;
                document.getElementById("call-avatar").src=getDefaultAvatar(name);
                document.getElementById("call-status").innerText=status;
                document.getElementById("answer-btn").style.display=isIncoming?"flex":"none";
            }
            function hangUp() { if(ws) ws.send(JSON.stringify({type:"hang_up", target:callTarget})); closeCall(); }
            function closeCall() {
                document.getElementById("call-overlay").style.display="none";
                if(peerConnection) { peerConnection.close(); peerConnection=null; }
                if(localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
                ringtone.pause(); ringtone.currentTime=0;
            }

            function connectWS() {
                var proto = window.location.protocol==='https:'?'wss:':'ws:';
                ws = new WebSocket(proto+"//"+window.location.host+"/ws/"+username);
                ws.onopen = () => { if(currentChannel) requestHistory(); };
                ws.onmessage = e => {
                    var d = JSON.parse(e.data);
                    if(d.type==="call_offer") handleOffer(d);
                    else if(d.type==="call_answer") handleAnswer(d);
                    else if(d.type==="new_ice_candidate") handleCandidate(d);
                    else if(d.type==="hang_up") closeCall();
                    else if(d.type==="initial_status") d.users.forEach(u=>updateStatus(u,'online'));
                    else if(d.type==="status") updateStatus(d.username, d.status);
                    else if(Array.isArray(d)) { document.getElementById('messages').innerHTML=''; d.reverse().forEach(addMsg); }
                    else if(d.type==="delete") { var el=document.getElementById("msg-"+d.message_id); if(el)el.remove(); }
                    else if(d.channel===currentChannel) { addMsg(d); if(d.username!==username) notifSound.play().catch(()=>{}); }
                };
            }

            function addMsg(d) {
                var l = document.getElementById('messages'); if(document.getElementById("msg-"+d.id))return;
                var me = d.username===username;
                var li = document.createElement('li'); li.className = "msg-row "+(me?"me":"other"); li.id="msg-"+d.id;
                var content = d.content.startsWith("data:image") ? `<img src="${d.content}" class="chat-image" onclick="document.getElementById('image-modal').style.display='flex';document.getElementById('modal-img').src=this.src;">` :
                              d.content.startsWith("data:audio") ? `<div class="audio-player"><div class="play-btn" onclick="playAudio(this, '${d.id}')">‚ñ∂</div><audio id="audio-${d.id}" src="${d.content}" onended="resetAudio(this)"></audio></div>` :
                              d.content;
                var del = (me||myIsAdmin)?`<span class="delete-btn" onclick="delMsg(${d.id})">${ICONS.trash}</span>`:"";
                var ava = `<img class="avatar" src="${d.avatar_url||getDefaultAvatar(d.username)}" onclick="viewProfile('${d.username}')">`;
                var info = `<div class="msg-bubble">${!me?`<span class="username">${d.username}</span>`:""}${content}<div class="timestamp">${d.created_at}</div></div>`;
                li.innerHTML = me ? del+info : ava+info+del;
                l.appendChild(li); l.scrollTop=l.scrollHeight;
            }

            function playAudio(btn, id) { var a=document.getElementById('audio-'+id); if(a.paused){a.play();btn.innerText="‚è∏";}else{a.pause();btn.innerText="‚ñ∂";} }
            function resetAudio(a) { a.parentElement.querySelector('.play-btn').innerText="‚ñ∂"; }
            function requestHistory() { if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:"history",channel:currentChannel})); }
            function sendMessage(e) { e.preventDefault(); var i=document.getElementById("messageText"); if(i.value.trim()){ ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:i.value})); i.value=''; } }
            function delMsg(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) ws.send(JSON.stringify({type:"delete", message_id:id})); }
            function handleFileSelect(i) { if(i.files[0]) { var r=new FileReader(); r.onload=e=>ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:e.target.result})); r.readAsDataURL(i.files[0]); i.value=''; } }
            function updateStatus(u,s) { var d=document.getElementById("status-"+u); if(d)d.style.display=(s==='online'?'inline-block':'none'); }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤
            async function loadDMs() {
                let r=await fetch("/get_dms?username="+username); let d=await r.json();
                let l=document.getElementById("dm-list"); l.innerHTML="";
                d.forEach(u => {
                    let div=document.createElement("div"); div.className="channel";
                    div.innerHTML=`<img src="${getDefaultAvatar(u)}" class="dm-avatar"><span style="flex-grow:1">${u}<span id="status-${u}" class="status-dot"></span></span>`;
                    div.onclick=()=>switchChat("dm_"+[username,u].sort().join("_"), u, true);
                    l.appendChild(div);
                });
            }
            async function loadGroups() {
                let r=await fetch("/get_my_groups?username="+username); let d=await r.json();
                let l=document.getElementById("groups-list"); l.innerHTML="";
                d.forEach(g => {
                    let div=document.createElement("div"); div.className="channel"; div.innerText=g.name;
                    div.onclick=()=>switchChat("group_"+g.id, g.name, false, g.id);
                    l.appendChild(div);
                });
            }
            async function loadRequests() {
                let r=await fetch("/get_requests?username="+username); let d=await r.json();
                let l=document.getElementById("requests-list"); l.innerHTML="";
                document.getElementById("requests-section").style.display=d.length?"block":"none";
                d.forEach(q => {
                    let div=document.createElement("div"); div.className="channel"; div.style.cursor="default";
                    div.innerHTML=`${q.sender} <span class="icon-btn" onclick="respondReq(${q.id},'accept')" style="margin-left:auto">‚úÖ</span><span class="icon-btn" onclick="respondReq(${q.id},'reject')">‚ùå</span>`;
                    l.appendChild(div);
                });
            }

            function switchChat(id, name, isDm, gid) {
                currentChannel=id; currentGroupId=gid;
                document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active')); event.currentTarget.classList.add('active');
                document.getElementById("header-title").innerText=name;
                document.getElementById("header-icon").innerText=isDm?"@":"#";
                document.getElementById("add-member-btn").style.display=gid?"block":"none";
                document.getElementById("call-btn").style.display=isDm?"flex":"none";
                document.getElementById("messages").innerHTML="";
                requestHistory(); closeSidebarOnMobile();
            }

            // –î–µ–π—Å—Ç–≤–∏—è
            async function sendFriendRequest() { var u=document.getElementById("dm-username").value; if(u) fetch("/send_request", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender:username,receiver:u})}).then(r=>{if(r.ok){alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");document.getElementById("dm-modal").style.display="none";}else alert("–û—à–∏–±–∫–∞")}); }
            async function createGroup() { var n=document.getElementById("group-name-input").value; if(n) fetch("/create_group", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,owner:username})}).then(r=>{if(r.ok){document.getElementById("create-group-modal").style.display="none";loadGroups();}}); }
            async function addMemberToGroup() { var u=document.getElementById("new-member-username").value; if(u) fetch("/add_member", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group_id:currentGroupId,username:u})}).then(r=>{if(r.ok){alert("–î–æ–±–∞–≤–ª–µ–Ω");document.getElementById("add-member-modal").style.display="none";}else alert("–û—à–∏–±–∫–∞")}); }
            async function respondReq(id, act) { fetch("/respond_request", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:id,action:act})}).then(r=>{if(r.ok){loadRequests();if(act==='accept')loadDMs();}}); }
            async function viewProfile(u) {
                try { let r=await fetch("/get_profile?username="+u); if(!r.ok)return; let d=await r.json();
                document.getElementById("view-username").innerHTML=d.username+(d.is_admin?ICONS.crown:"");
                document.getElementById("view-bio").innerText=d.bio;
                document.getElementById("view-avatar").src=d.avatar_url||getDefaultAvatar(d.username);
                document.getElementById("view-details").innerHTML=`–ò–º—è: ${d.real_name||"-"}<br>–ì–æ—Ä–æ–¥: ${d.location||"-"}<br>–î–†: ${d.birth_date||"-"}<br>–°–æ—Ü—Å–µ—Ç–∏: ${d.social_link||"-"}`;
                document.getElementById("user-profile-modal").style.display="flex"; } catch(e){}
            }
            async function saveProfile() {
                let body={username:username, bio:document.getElementById("settings-bio").value, avatar_url:currentUserAvatar, real_name:document.getElementById("settings-realname").value, location:document.getElementById("settings-location").value, birth_date:document.getElementById("settings-birthdate").value, social_link:document.getElementById("settings-social").value};
                let r=await fetch("/update_profile", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
                if(r.ok) { let d=await r.json(); updateMyUI(d); document.getElementById("settings-modal").style.display="none"; }
            }
            function previewAvatar(i) { if(i.files[0]) { var r=new FileReader(); r.onload=e=> { tempAvatarBase64=e.target.result; document.getElementById("settings-avatar-preview").src=tempAvatarBase64; currentUserAvatar=tempAvatarBase64; }; r.readAsDataURL(i.files[0]); } }
            async function toggleMic() { if(!isRecording){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(s);audioChunks=[];mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);mediaRecorder.onstop=()=>{const b=new Blob(audioChunks,{type:'audio/mp3'});const r=new FileReader();r.onload=()=>{ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:r.result}))};r.readAsDataURL(b);s.getTracks().forEach(t=>t.stop());};mediaRecorder.start();isRecording=true;document.getElementById("mic-btn").classList.add("recording");}catch(e){alert("Mic Error");}}else{mediaRecorder.stop();isRecording=false;document.getElementById("mic-btn").classList.remove("recording");}}
        </script>
    </body>
</html>
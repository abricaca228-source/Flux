<!DOCTYPE html>
<html>
    <head>
        <title>Flux</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        <link rel="manifest" href="/static/manifest.json">
        <link rel="icon" type="image/png" href="/static/icon.png">
        <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;800&display=swap" rel="stylesheet">
        
        <style>
            /* --- –û–°–ù–û–í–ê --- */
            :root { --bg-deep:#0f0c29; --bg-medium:#1a163a; --bg-light:#302b63; --accent-primary:#00d2ff; --accent-secondary:#3a7bd5; --text-main:#ffffff; --text-dim:#b8b8d0; --danger:#ff416c; --success:#00f260; --glass:rgba(255,255,255,0.05); --glass-border:rgba(255,255,255,0.1); }
            * { box-sizing: border-box; }
            body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: linear-gradient(135deg, var(--bg-deep), #24243e); color: var(--text-main); font-family: 'Exo 2', sans-serif; }
            #app-container { display: none; width: 100%; height: 100%; display: flex; }

            /* --- –°–ê–ô–î–ë–ê–† --- */
            .sidebar { width: 280px; min-width: 280px; background: rgba(15, 12, 41, 0.98); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; height: 100%; overflow-y: auto; z-index: 20; }
            .sidebar-title { font-weight: 800; padding: 25px 20px 10px 20px; color: var(--text-dim); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
            .channel { padding: 10px 15px; margin: 2px 10px; border-radius: 12px; cursor: pointer; color: var(--text-dim); font-weight: 600; display: flex; align-items: center; transition: 0.2s; font-size: 14px; }
            .channel:hover { background: var(--glass); color: white; }
            .channel.active { background: linear-gradient(90deg, rgba(0, 210, 255, 0.1), transparent); color: white; border-left: 3px solid var(--accent-primary); }
            .dm-avatar { width: 32px; height: 32px; min-width: 32px; border-radius: 50%; margin-right: 10px; background: linear-gradient(135deg, #667eea, #764ba2); object-fit: cover; }
            .user-panel { background: rgba(0,0,0,0.2); padding: 15px 20px; display: flex; align-items: center; cursor: pointer; margin-top: auto; border-top: 1px solid var(--glass-border); }
            .my-avatar { width: 38px; height: 38px; border-radius: 50%; background-color: #5865f2; margin-right: 10px; object-fit: cover; }
            .my-info { flex-grow: 1; overflow: hidden; } .my-name { font-weight: bold; font-size: 14px; } .my-bio { font-size: 11px; color: var(--accent-primary); opacity: 0.8; }

            /* --- –ß–ê–¢ --- */
            .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: radial-gradient(circle at top right, #1a163a 0%, #0f0c29 60%); position: relative; width: 100%; }
            .chat-header { height: 65px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; padding: 0 20px; font-weight: 800; color: white; flex-shrink: 0; background: rgba(15, 12, 41, 0.95); backdrop-filter: blur(10px); justify-content: space-between; z-index: 10; position: relative;}
            .hamburger { display: none; margin-right: 15px; font-size: 24px; cursor: pointer; color: white; }
            .header-actions { display: flex; gap: 10px; align-items: center; }
            .add-member-header-btn { cursor: pointer; background: linear-gradient(90deg, var(--success), #00b09b); color: #0f0c29; font-weight: 800; padding: 6px 14px; border-radius: 20px; font-size: 12px; display: none; }
            .call-btn, .search-btn { cursor: pointer; color: var(--success); display: none; padding: 0; border-radius: 50%; border: 2px solid var(--success); width: 34px; height: 34px; align-items: center; justify-content: center; transition: 0.3s; font-size: 16px; }
            .search-btn { color: var(--accent-primary); border-color: var(--accent-primary); display: flex; margin-right: 5px; }
            .call-btn:hover, .search-btn:hover { background: var(--glass); transform: scale(1.1); }

            /* –ü–û–ò–°–ö */
            #search-bar { display: none; position: absolute; top: 70px; right: 20px; width: 300px; background: rgba(15, 12, 41, 0.98); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
            .search-input { width: 100%; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.1); border: none; color: white; margin-bottom: 10px; outline: none; }
            #search-results { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
            .search-result-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; font-size: 13px; cursor: pointer; border-left: 2px solid var(--accent-secondary); }
            .search-result-item:hover { background: rgba(255,255,255,0.1); }
            .sr-user { font-weight: bold; color: var(--accent-primary); font-size: 11px; }
            .sr-text { color: #b8b8d0; margin-top: 2px; }

            /* --- –°–û–û–ë–©–ï–ù–ò–Ø --- */
            #messages { list-style-type: none; margin: 0; padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
            .msg-row { display: flex; width: 100%; align-items: flex-end; position: relative; margin-bottom: 5px; }
            .msg-row.me { justify-content: flex-end; padding-right: 10px; } .msg-row.other { justify-content: flex-start; }
            .msg-bubble { max-width: 75%; padding: 10px 16px; border-radius: 18px; position: relative; word-wrap: break-word; font-size: 15px; line-height: 1.4; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: opacity 1s ease; }
            .msg-row.other .msg-bubble { background: rgba(255, 255, 255, 0.08); border: 1px solid var(--glass-border); border-bottom-left-radius: 4px; margin-left: 8px; }
            .msg-row.me .msg-bubble { background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); color: #0f0c29; border-bottom-right-radius: 4px; font-weight: 500; }
            
            /* –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ –î–ê–¢ */
            .date-separator { text-align: center; margin: 15px 0; position: relative; display: flex; align-items: center; justify-content: center; }
            .date-separator::before, .date-separator::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); margin: 0 10px; }
            .date-label { background: rgba(255,255,255,0.1); color: var(--text-dim); font-size: 11px; padding: 4px 12px; border-radius: 12px; font-weight: bold; }

            /* –ö–ê–†–¢–ò–ù–ö–ò */
            .chat-image { max-width: 100%; max-height: 250px; width: auto; border-radius: 12px; margin-top: 5px; cursor: pointer; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.2s; }
            .chat-image:hover { transform: scale(1.02); }

            /* –ê–£–î–ò–û */
            .custom-player { display: flex; align-items: center; gap: 10px; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.15); padding: 8px 12px; border-radius: 14px; width: 240px; margin-top: 5px; }
            .msg-row.me .custom-player { background: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.3); }
            .play-icon { width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--accent-primary); cursor: pointer; flex-shrink: 0; transition: 0.2s; }
            .play-icon:hover { transform: scale(1.1); }
            .track-bar { flex-grow: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: relative; cursor: pointer; }
            .track-progress { height: 100%; width: 0%; background: white; border-radius: 2px; position: relative; transition: width 0.1s linear; }
            .track-progress::after { content: ''; position: absolute; right: -5px; top: -3px; width: 10px; height: 10px; background: white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
            .track-time { font-size: 10px; width: 35px; text-align: right; font-family: monospace; opacity: 0.8; }

            /* –®–ü–ò–û–ù–°–ö–ò–ô –†–ï–ñ–ò–ú */
            .spy-msg { border: 2px solid var(--danger) !important; background: rgba(255, 65, 108, 0.1) !important; color: white !important; }
            .spy-header { font-size: 11px; color: var(--danger); font-weight: 800; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; text-transform: uppercase; letter-spacing: 1px; }
            .spy-timer { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

            /* –û–°–¢–ê–õ–¨–ù–û–ï */
            .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-bottom: 2px; cursor: pointer; flex-shrink: 0;}
            .msg-row.me .avatar { display: none; }
            .username { font-weight: 700; font-size: 12px; color: var(--accent-primary); margin-bottom: 3px; display: block; cursor: pointer; }
            .timestamp { font-size: 10px; color: rgba(255,255,255,0.5); }
            .msg-row.me .timestamp { color: rgba(15, 12, 41, 0.6); }
            
            .msg-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px; }
            .read-ticks { font-size: 10px; color: var(--accent-primary); font-weight: bold; }
            
            .msg-actions { position: absolute; bottom: -30px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; z-index: 10; background: rgba(15, 12, 41, 0.95); padding: 5px 10px; border-radius: 20px; border: 1px solid var(--accent-primary); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
            .msg-row.me .msg-actions { right: 10px; } .msg-row.other .msg-actions { left: 50px; }
            .msg-row:hover .msg-actions { opacity: 1; bottom: -20px; }
            .action-btn { cursor: pointer; font-size: 16px; transition: 0.2s; padding: 2px; }
            .action-btn:hover { transform: scale(1.3); }
            .reactions-display { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; justify-content: flex-end; }
            .msg-row.other .reactions-display { justify-content: flex-start; }
            .reaction-pill { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 2px 6px; font-size: 11px; cursor: pointer; transition: 0.2s; color: white; user-select: none; }
            .msg-row.me .reaction-pill { background: rgba(255,255,255,0.25); color: #0f0c29; border-color: rgba(0,0,0,0.1); }

            /* –í–í–û–î */
            form { padding: 0 20px 20px 20px; margin: 0; width: 100%; flex-shrink: 0; position: relative; }
            .input-wrapper { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 24px; display: flex; align-items: center; padding: 5px 10px; width: 100%; backdrop-filter: blur(10px); transition: 0.3s; }
            .input-wrapper.editing { border-color: var(--success); box-shadow: 0 0 15px rgba(0, 242, 96, 0.2); }
            
            /* –£–°–ò–õ–ï–ù–ù–´–ô –≠–§–§–ï–ö–¢ –®–ü–ò–û–ù–ê –í –ü–û–õ–ï –í–í–û–î–ê */
            .input-wrapper.spy-active { 
                border-color: var(--danger); 
                box-shadow: 0 0 20px rgba(255, 65, 108, 0.3), inset 0 0 20px rgba(255, 65, 108, 0.1); 
                background: rgba(40, 10, 20, 0.6);
            }
            .input-wrapper.spy-active input::placeholder { color: var(--danger); opacity: 0.7; }
            
            input[type="text"] { flex-grow: 1; padding: 12px; border: none; background: transparent; color: white; outline: none; font-size: 16px; font-family: 'Exo 2'; }
            
            .icon-btn-input { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
            .icon-btn-input:hover { background: rgba(255,255,255,0.1); color: white; }
            .mic-btn.recording { color: var(--danger); animation: pulse 1s infinite; background: rgba(255, 65, 108, 0.1); }
            
            .spy-btn { transition: 0.3s; }
            .spy-btn.active { color: var(--danger); transform: scale(1.1); filter: drop-shadow(0 0 5px var(--danger)); }
            
            #edit-indicator { display: none; position: absolute; bottom: 85px; left: 40px; background: var(--success); color: #0f0c29; padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; }
            #reply-bar { display: none; background: rgba(0, 0, 0, 0.5); padding: 8px 20px; color: var(--text-dim); font-size: 13px; border-top: 1px solid var(--glass-border); align-items: center; }
            #reply-bar span { color: var(--accent-primary); font-weight: bold; margin-right: 5px; }
            #reply-close { margin-left: auto; cursor: pointer; font-size: 18px; }
            
            /* –≠–ö–†–ê–ù–´ */
            #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, #302b63 0%, #0f0c29 100%); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center;}
            .logo-f { font-size: 120px; font-weight: 900; background: linear-gradient(to bottom, #00ffff, #0055ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;}
            .login-box { width: 90%; max-width: 360px; text-align: center; }
            .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 10px; outline: none; font-size: 16px; }
            .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; font-size: 15px; text-transform: uppercase; margin-bottom: 10px; background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); }
            .error-msg { display: none; color: var(--danger); margin-bottom: 10px; font-weight: bold; }
            
            #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
            .call-avatar { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--accent-primary); margin-bottom: 20px; object-fit: cover; animation: pulse 2s infinite; }
            .call-actions { display: flex; gap: 40px; } .call-action-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
            .btn-answer { background: var(--success); color: white; } .btn-hangup { background: var(--danger); color: white; }
            .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
            .modal-content { background: #1a163a; padding: 25px; border-radius: 20px; width: 400px; text-align: center; border: 1px solid var(--glass-border); position: relative; }
            .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-dim); }
            .settings-input { width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; }
            .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; margin-left: 6px; box-shadow: 0 0 5px var(--success); display: none; vertical-align: middle;}
            .icon-btn { cursor: pointer; color: var(--text-dim); display: inline-flex; align-items: center; justify-content: center; padding: 5px; border-radius: 5px; transition: 0.2s; }
            .icon-btn:hover { color: var(--accent-primary); background: var(--glass); transform: scale(1.1); }

            @media (max-width: 768px) {
                .sidebar { position: absolute; height: 100%; transform: translateX(-100%); width: 280px; }
                .sidebar.open { transform: translateX(0); }
                .hamburger { display: block !important; }
                #overlay { display: none; position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 15; }
                #overlay.show { display: block; }
                .msg-bubble { max-width: 85%; }
                .msg-row.me { padding-right: 0; }
                #search-bar { width: 90%; right: 5%; }
            }
            @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        </style>
    </head>
    <body>
        <div id="image-modal" class="modal" onclick="this.style.display='none'"><span class="close-btn">&times;</span><img id="modal-img" style="max-width:100%;max-height:80vh;"></div>
        <div id="call-overlay"><img id="call-avatar" class="call-avatar" src=""><div id="call-username" style="font-size:24px;font-weight:bold;color:white;margin-bottom:10px;"></div><div id="call-status" style="font-size:16px;color:#b8b8d0;margin-bottom:40px;"></div><div class="call-actions"><button id="answer-btn" class="call-action-btn btn-answer" onclick="answerCall()">üìû</button><button id="hangup-btn" class="call-action-btn btn-hangup" onclick="hangUp()">‚ùå</button></div><audio id="remote-audio" autoplay playsinline></audio></div>
        <div id="settings-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="document.getElementById('settings-modal').style.display='none'">&times;</span><h2>–ü—Ä–æ—Ñ–∏–ª—å</h2><img id="settings-avatar-preview" style="width:100px;height:100px;border-radius:50%;margin-bottom:15px;object-fit:cover;" src=""><label class="btn" style="display:block;margin-bottom:15px;">–§–æ—Ç–æ<input type="file" style="display:none;" accept="image/*" onchange="previewAvatar(this)"></label><input id="settings-bio" class="settings-input" placeholder="–°—Ç–∞—Ç—É—Å"><input id="settings-realname" class="settings-input" placeholder="–ò–º—è"><input id="settings-location" class="settings-input" placeholder="–ì–æ—Ä–æ–¥"><input id="settings-birthdate" class="settings-input" placeholder="–î–†"><input id="settings-social" class="settings-input" placeholder="–°–æ—Ü—Å–µ—Ç–∏"><button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>
        <div id="dm-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–ù–∞–π—Ç–∏</h2><input id="dm-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º"><button class="btn" onclick="sendFriendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div></div>
        <div id="create-group-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–ì—Ä—É–ø–ø–∞</h2><input id="group-name-input" class="settings-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><button class="btn" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button></div></div>
        <div id="add-member-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span><h2>–î–æ–±–∞–≤–∏—Ç—å</h2><input id="new-member-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º"><button class="btn" onclick="addMemberToGroup()">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>
        <div id="user-profile-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="document.getElementById('user-profile-modal').style.display='none'">&times;</span><img id="view-avatar" style="width:100px;height:100px;border-radius:50%;margin-bottom:15px;object-fit:cover;" src=""><h2 id="view-username"></h2><p id="view-bio"></p><div id="view-details" style="text-align:left;margin-top:15px;"></div></div></div>

        <div id="login-screen">
            <div class="logo-container"><div style="font-size:100px;font-weight:900;background:linear-gradient(to bottom, #00ffff, #0055ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">F</div><div style="color:#00d2ff;letter-spacing:5px;font-weight:bold;">FLUX</div></div>
            <div class="login-box" style="margin-top:30px;">
                <input type="text" id="usernameInput" class="login-input" placeholder="–ù–∏–∫–Ω–µ–π–º" />
                <input type="password" id="passwordInput" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" />
                <div id="errorMsg" class="error-msg">–û—à–∏–±–∫–∞</div>
                <button class="btn" onclick="auth('login')">–í–æ–π—Ç–∏</button>
                <button class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.1);" onclick="auth('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
        </div>

        <div id="app-container">
            <div id="overlay" onclick="toggleSidebar()"></div>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-title">–ß–ê–¢–´ <span class="icon-btn" style="color:var(--accent-primary)" onclick="document.getElementById('create-group-modal').style.display='flex'">+</span></div><div id="groups-list"></div>
                <div class="sidebar-title">–õ–ò–ß–ù–´–ï <span class="icon-btn" style="color:var(--accent-primary)" onclick="document.getElementById('dm-modal').style.display='flex'">+</span></div><div id="dm-list"></div>
                <div id="requests-section" style="display:none;"><div class="sidebar-title" style="color:var(--success);">–ó–ê–Ø–í–ö–ò</div><div id="requests-list"></div></div>
                <div class="user-panel" onclick="openSettings()"><img id="my-avatar-img" class="my-avatar" src=""><div class="my-info"><div id="my-name-text" class="my-name"></div><div id="my-bio-text" class="my-bio"></div></div><div class="settings-btn">‚öôÔ∏è</div></div>
            </div>
            <div class="chat-area">
                <div class="chat-header">
                    <div class="header-left"><span class="hamburger" onclick="toggleSidebar()">‚ò∞</span><span id="header-title">Flux</span></div>
                    <div class="header-actions">
                        <span class="search-btn" onclick="toggleSearch()"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span>
                        <span id="call-btn" class="call-btn" onclick="startCall()">üìû</span>
                        <span id="add-member-btn" class="add-member-header-btn" onclick="document.getElementById('add-member-modal').style.display='flex'">+–ß–µ–ª–æ–≤–µ–∫</span>
                    </div>
                </div>
                <div id="search-bar">
                    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." oninput="doSearch(this.value)">
                    <div id="search-results"></div>
                </div>
                <ul id='messages'></ul><div id="typing-indicator"></div>
                <div id="reply-bar">–û—Ç–≤–µ—Ç: <span id="reply-username"></span><div id="reply-close" onclick="cancelReply()">‚úï</div></div>
                <form action="" onsubmit="sendMessage(event)">
                    <div id="edit-indicator">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ... (Esc –æ—Ç–º–µ–Ω–∞)</div>
                    <div class="input-wrapper" id="input-box">
                        <label class="icon-btn-input"><input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></label>
                        <div class="icon-btn-input spy-btn" id="spy-btn" onclick="toggleSpyMode()"><svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M11 20H13V22H11V20ZM11 2H13V5H11V2ZM19.53 18.12L20.95 19.53L19.53 19.53L18.12 18.12C17.27 18.7 16.32 19.14 15.31 19.43V21.43C16.89 21.1 18.33 20.45 19.53 19.53ZM4.47 18.12C3.62 17.27 2.97 16.32 2.57 15.31H4.57C4.86 16.32 5.3 17.27 5.88 18.12L4.47 19.53L5.88 19.53L4.47 18.12ZM2.57 8.69C2.97 7.68 3.62 6.73 4.47 5.88L5.88 4.47L4.47 4.47L2.57 5.88C2.28 6.89 2.1 8 2.1 9.17H4.1C4.1 8.69 4.19 8.23 4.34 7.8L2.57 8.69ZM12 7C9.24 7 7 9.24 7 12C7 14.76 9.24 17 12 17C14.76 17 17 14.76 17 12C17 9.24 14.76 7 12 7ZM19.66 7.8L17.89 8.69C18.04 9.12 18.1 9.58 18.1 10.05H20.1C20.1 8.88 19.92 7.77 19.66 6.75V7.8Z"/></svg></div>
                        <input type="text" id="messageText" autocomplete="off" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
                        <div id="mic-btn" class="icon-btn-input mic-btn" onclick="toggleMic()"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const ICONS = {crown:`<span style="color:gold;margin-left:4px">üëë</span>`, trash: `üóëÔ∏è`, edit: `‚úèÔ∏è`, reply: `‚Ü©Ô∏è`};
            const notifSound = new Audio("https://cdn.freesound.org/previews/235/235911_2391840-lq.mp3");
            const ringtone = new Audio("https://cdn.freesound.org/previews/351/351239_1241198-lq.mp3"); ringtone.loop=true;
            var ws, username, currentUserAvatar, tempAvatarBase64, myIsAdmin, currentChannel, currentGroupId;
            var mediaRecorder, audioChunks=[], isRecording=false, typingTimeout, lastTypingSent=0;
            var localStream, peerConnection, callTarget, editingMessageId = null, replyToId = null, isSpyMode = false;
            const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }, { urls: "stun:stun1.l.google.com:19302" }] };
            let lastDate = null; // –î–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –¥–∞—Ç

            function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("show"); }
            function closeSidebarOnMobile() { if(window.innerWidth<=768) toggleSidebar(); }
            function getDefaultAvatar(n) { return `https://ui-avatars.com/api/?name=${n}&background=0f0c29&color=00d2ff&size=128&bold=true`; }
            function openSettings() { document.getElementById("settings-modal").style.display='flex'; document.getElementById("settings-avatar-preview").src=currentUserAvatar; document.getElementById("settings-bio").value=document.getElementById("my-bio-text").innerText; }

            async function auth(type) {
                var u = document.getElementById("usernameInput").value, p = document.getElementById("passwordInput").value;
                if(!u||!p)return;
                try {
                    let r = await fetch("/"+type, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
                    if(r.ok) {
                        let d = await r.json(); username=u; myIsAdmin=d.is_admin;
                        updateMyUI(d); loadDMs(); loadGroups(); loadRequests();
                        document.getElementById("login-screen").style.display="none"; 
                        document.getElementById("app-container").style.display="flex";
                        connectWS();
                        ['realname','location','birthdate','social'].forEach(k => document.getElementById("settings-"+k).value=d[k=="realname"?"real_name":k=="social"?"social_link":k]||"");
                    } else { let e=document.getElementById("errorMsg"); e.innerText=(await r.json()).detail; e.style.display="block"; }
                } catch(e) { alert("Network Error"); }
            }
            function updateMyUI(d) {
                currentUserAvatar = d.avatar_url && !d.avatar_url.includes("discord") ? d.avatar_url : getDefaultAvatar(username);
                document.getElementById("my-name-text").innerHTML = username + (d.is_admin?ICONS.crown:"");
                document.getElementById("my-bio-text").innerText = d.bio || "Online";
                document.getElementById("my-avatar-img").src = currentUserAvatar;
            }

            function connectWS() {
                var proto = window.location.protocol==='https:'?'wss:':'ws:';
                ws = new WebSocket(proto+"//"+window.location.host+"/ws/"+username);
                ws.onopen = () => { if(currentChannel) requestHistory(); };
                ws.onmessage = e => {
                    var d = JSON.parse(e.data);
                    if(d.type==="call_offer") { d.sender=d.sender||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"; handleOffer(d); }
                    else if(d.type==="call_answer") handleAnswer(d);
                    else if(d.type==="new_ice_candidate") handleCandidate(d);
                    else if(d.type==="hang_up") closeCall();
                    else if(d.type==="initial_status") d.users.forEach(u=>updateStatus(u,'online'));
                    else if(d.type==="status") updateStatus(d.username, d.status);
                    else if(d.type==="reaction_update") {
                        let row = document.getElementById("msg-"+d.message_id);
                        if(row) {
                            let bubble = row.querySelector('.msg-bubble');
                            let oldReactions = bubble.querySelector('.reactions-display');
                            if(oldReactions) oldReactions.remove();
                            let newReactionsHtml = "";
                            if(d.reactions && Object.keys(d.reactions).length > 0) {
                                newReactionsHtml = '<div class="reactions-display">';
                                for (const [emoji, users] of Object.entries(d.reactions)) {
                                    newReactionsHtml += `<div class="reaction-pill" onclick="sendReaction(${d.message_id}, '${emoji}')">${emoji} ${users.length}</div>`;
                                }
                                newReactionsHtml += '</div>';
                                bubble.insertAdjacentHTML('beforeend', newReactionsHtml);
                            }
                        }
                    }
                    else if(d.type==="edit_update") {
                        let contentDiv = document.querySelector(`#msg-${d.message_id} .content-text`);
                        if(contentDiv) {
                            contentDiv.innerText = d.new_content;
                            let bubble = contentDiv.closest('.msg-bubble');
                            if(!bubble.querySelector('.edited-label')) bubble.insertAdjacentHTML('beforeend', '<span class="edited-label">(—Ä–µ–¥.)</span>');
                        }
                    }
                    else if(d.type==="read_update") {
                        let row = document.getElementById("msg-"+d.message_id);
                        if(row) {
                            let ticks = row.querySelector('.read-ticks');
                            if(ticks) ticks.innerHTML = d.readers.length > 0 ? "‚úì‚úì" : "‚úì";
                        }
                    }
                    else if(Array.isArray(d)) { 
                        document.getElementById('messages').innerHTML=''; 
                        lastDate = null; // –°–±—Ä–æ—Å –¥–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏
                        d.reverse().forEach(addMsg); 
                    }
                    else if(d.type==="delete") { var el=document.getElementById("msg-"+d.message_id); if(el)el.remove(); }
                    else if(d.channel===currentChannel) { 
                        addMsg(d); 
                        if(d.username!==username) { 
                            notifSound.play().catch(()=>{});
                            ws.send(JSON.stringify({type:"mark_read", message_id: d.id}));
                        } 
                    }
                };
            }

            function formatDate(dateStr) {
                // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —à–ª–µ—Ç —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è, –Ω–∞–¥–æ –±—ã —Å–ª–∞—Ç—å –ø–æ–ª–Ω—É—é –¥–∞—Ç—É)
                // –î–ª—è MVP –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è/–≤—á–µ—Ä–∞, 
                // –ù–æ –ª—É—á—à–µ, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —Å–ª–∞–ª –ø–æ–ª–Ω—É—é –¥–∞—Ç—É. –ü–æ–∫–∞ —Å–¥–µ–ª–∞–µ–º –∏–º–∏—Ç–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ:
                // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç - —ç—Ç–æ "–°–µ–≥–æ–¥–Ω—è".
                return "–°–µ–≥–æ–¥–Ω—è"; 
                // –í –∏–¥–µ–∞–ª–µ: —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–ª–∞—Ç—å –ø–æ–ª–µ `date` (YYYY-MM-DD)
            }

            function addMsg(d) {
                var l = document.getElementById('messages'); if(document.getElementById("msg-"+d.id))return;
                
                // --- –í–°–¢–ê–í–ö–ê –†–ê–ó–î–ï–õ–ò–¢–ï–õ–Ø –î–ê–¢ ---
                // (–£–ø—Ä–æ—â–µ–Ω–Ω–æ: –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "–°–µ–≥–æ–¥–Ω—è" –¥–ª—è –Ω–æ–≤—ã—Ö)
                // –ß—Ç–æ–±—ã —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –∏–¥–µ–∞–ª—å–Ω–æ, —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—ã–ª–∞—Ç—å –ø–æ–ª–Ω—É—é –¥–∞—Ç—É –≤ `created_at`
                // –ü–æ–∫–∞ –¥–æ–±–∞–≤–∏–º "–°–µ–≥–æ–¥–Ω—è" –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏
                if (lastDate === null) {
                    let sep = document.createElement('div');
                    sep.className = "date-separator";
                    sep.innerHTML = `<span class="date-label">–°–µ–≥–æ–¥–Ω—è</span>`;
                    l.appendChild(sep);
                    lastDate = "Today";
                }

                var me = d.username===username;
                var li = document.createElement('li'); li.className = "msg-row "+(me?"me":"other"); li.id="msg-"+d.id;
                
                let bubbleClass = d.timer > 0 ? "msg-bubble spy-msg" : "msg-bubble";
                let spyHeader = "";
                
                if(d.timer > 0) {
                    spyHeader = `<div class="spy-header">üî• –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ <span id="timer-${d.id}" class="spy-timer">10—Å</span></div>`;
                    let timeLeft = 10;
                    let timerId = setInterval(() => {
                        timeLeft--;
                        let t = document.getElementById(`timer-${d.id}`);
                        if(t) t.innerText = timeLeft + "—Å";
                        if(timeLeft <= 0) {
                            clearInterval(timerId);
                            let r = document.getElementById(`msg-${d.id}`);
                            if(r) { r.querySelector(".msg-bubble").style.opacity = "0"; setTimeout(() => r.remove(), 1000); }
                        }
                    }, 1000);
                }

                var contentHtml = "";
                if (d.content.startsWith("data:image")) contentHtml = `<img src="${d.content}" class="chat-image" onclick="document.getElementById('image-modal').style.display='flex';document.getElementById('modal-img').src=this.src;">`;
                else if (d.content.startsWith("data:audio")) {
                    contentHtml = `<div class="custom-player"><div class="play-icon" onclick="toggleAudio(${d.id})">‚ñ∂</div><div class="track-bar" onclick="seekAudio(event, ${d.id})"><div id="prog-${d.id}" class="track-progress"></div></div><div id="time-${d.id}" class="track-time">0:00</div><audio id="audio-${d.id}" src="${d.content}" ontimeupdate="updateAudioProgress(${d.id})" onended="resetAudio(${d.id})" onloadedmetadata="setAudioDuration(${d.id})"></audio></div>`;
                }
                else contentHtml = `${spyHeader}<span class="content-text">${d.content}</span>` + (d.is_edited ? '<span class="edited-label">(—Ä–µ–¥.)</span>' : '');
                
                let reactionsHtml = "";
                if(d.reactions && Object.keys(d.reactions).length > 0) {
                    reactionsHtml = '<div class="reactions-display">';
                    for (const [emoji, users] of Object.entries(d.reactions)) {
                        reactionsHtml += `<div class="reaction-pill" onclick="sendReaction(${d.id}, '${emoji}')">${emoji} ${users.length}</div>`;
                    }
                    reactionsHtml += '</div>';
                }

                let replyHtml = d.reply_preview ? `<div style="font-size:11px;margin-bottom:5px;opacity:0.7;border-left:2px solid white;padding-left:5px;"><b>${d.reply_preview.username}</b>: ${d.reply_preview.content.substring(0, 20)}...</div>` : "";
                let ticks = me ? `<span class="read-ticks">${d.read_by && d.read_by.length > 0 ? "‚úì‚úì" : "‚úì"}</span>` : "";

                var actions = `<div class="msg-actions"><span class="action-btn" onclick="startReply(${d.id}, '${d.username}')">${ICONS.reply}</span>${(me || myIsAdmin) && !d.content.startsWith("data:") ? `<span class="action-btn" onclick="startEdit(${d.id}, this)">${ICONS.edit}</span>` : ""}${(me || myIsAdmin) ? `<span class="action-btn" style="color:var(--danger)" onclick="delMsg(${d.id})">${ICONS.trash}</span>` : ""}<span class="action-btn" onclick="sendReaction(${d.id}, 'üëç')">üëç</span><span class="action-btn" onclick="sendReaction(${d.id}, '‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="action-btn" onclick="sendReaction(${d.id}, 'üòÇ')">üòÇ</span></div>`;

                var ava = `<img class="avatar" src="${d.avatar_url||getDefaultAvatar(d.username)}" onclick="viewProfile('${d.username}')">`;
                var info = `<div class="${bubbleClass}">${replyHtml}${!me?`<span class="username">${d.username}</span>`:""}${contentHtml}${reactionsHtml}<div class="msg-meta">${ticks}<span class="timestamp">${d.created_at}</span></div>${actions}</div>`;
                li.innerHTML = me ? info : ava+info;
                l.appendChild(li); l.scrollTop=l.scrollHeight;
                if (!me) ws.send(JSON.stringify({type:"mark_read", message_id: d.id}));
            }

            function toggleSearch() {
                var sb = document.getElementById("search-bar");
                sb.style.display = (sb.style.display === "block") ? "none" : "block";
                if(sb.style.display === "block") document.querySelector(".search-input").focus();
            }

            let searchTimeout;
            function doSearch(query) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    if(query.length < 2) { document.getElementById("search-results").innerHTML=""; return; }
                    let r = await fetch(`/search?channel=${currentChannel}&query=${query}`);
                    let data = await r.json();
                    let html = "";
                    data.forEach(m => {
                        html += `<div class="search-result-item" onclick="alert('–ü–æ–∫–∞ –ø–æ–∏—Å–∫ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!')"><div class="sr-user">${m.username} <span style="opacity:0.5;float:right">${m.created_at}</span></div><div class="sr-text">${m.content}</div></div>`;
                    });
                    document.getElementById("search-results").innerHTML = html || "<div style='padding:10px;color:gray;text-align:center'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>";
                }, 500);
            }

            window.sendReaction = function(id, emoji) { if(ws) ws.send(JSON.stringify({ type: "reaction", message_id: id, emoji: emoji })); }
            
            window.toggleSpyMode = function() { 
                isSpyMode = !isSpyMode; 
                document.getElementById("spy-btn").classList.toggle("active"); 
                // –ü–£–õ–¨–°–ê–¶–ò–Ø –ò –ö–†–ê–°–ù–´–ô –§–û–ù –ü–†–ò –í–ö–õ–Æ–ß–ï–ù–ò–ò
                document.querySelector(".input-wrapper").classList.toggle("spy-active"); 
            }
            
            window.startReply = function(id, username) { replyToId = id; document.getElementById("reply-bar").style.display = "flex"; document.getElementById("reply-username").innerText = username; document.getElementById("messageText").focus(); }
            window.cancelReply = function() { replyToId = null; document.getElementById("reply-bar").style.display = "none"; }
            window.toggleAudio = function(id) { var a=document.getElementById('audio-'+id); var btn=a.parentElement.querySelector('.play-icon'); if(a.paused){a.play();btn.innerText="‚è∏";}else{a.pause();btn.innerText="‚ñ∂";} };
            window.updateAudioProgress = function(id) { var a=document.getElementById('audio-'+id); if(a.duration) document.getElementById('prog-'+id).style.width=((a.currentTime/a.duration)*100)+'%'; };
            window.setAudioDuration = function(id) { var a=document.getElementById('audio-'+id); if(a.duration) { var m=Math.floor(a.duration/60), s=Math.floor(a.duration%60); document.getElementById('time-'+id).innerText=m+':'+(s<10?'0'+s:s); } };
            window.seekAudio = function(e,id){ var a=document.getElementById('audio-'+id); var c=e.currentTarget; var p=(e.offsetX/c.clientWidth); a.currentTime=p*a.duration; };
            window.resetAudio = function(id){ document.getElementById('audio-'+id).parentElement.querySelector('.play-icon').innerText="‚ñ∂"; document.getElementById('prog-'+id).style.width='0%'; };
            window.startEdit = function(id, btn) { let row = document.getElementById("msg-" + id); let textSpan = row.querySelector(".content-text"); if(!textSpan) return; editingMessageId = id; let input = document.getElementById("messageText"); input.value = textSpan.innerText; input.focus(); document.getElementById("input-box").classList.add("editing"); document.getElementById("edit-indicator").style.display = "block"; };
            window.cancelEdit = function() { editingMessageId = null; document.getElementById("messageText").value = ""; document.getElementById("input-box").classList.remove("editing"); document.getElementById("edit-indicator").style.display = "none"; }
            document.getElementById("messageText").addEventListener("keydown", function(e) { if(e.key === "Escape") { cancelEdit(); cancelReply(); } });
            function sendMessage(e) { e.preventDefault(); var i=document.getElementById("messageText"); if(!i.value.trim()) return; if (editingMessageId) { ws.send(JSON.stringify({type: "edit_message", message_id: editingMessageId, new_content: i.value, channel: currentChannel })); cancelEdit(); } else { ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:i.value,reply_to: replyToId,timer: isSpyMode ? 10 : 0})); i.value=''; cancelReply(); if(isSpyMode) toggleSpyMode(); } }
            function requestHistory() { if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:"history",channel:currentChannel})); }
            function delMsg(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) ws.send(JSON.stringify({type:"delete", message_id:id})); }
            function handleFileSelect(i) { if(i.files[0]) { var r=new FileReader(); r.onload=e=>ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:e.target.result})); r.readAsDataURL(i.files[0]); i.value=''; } }
            function updateStatus(u,s) { var d=document.getElementById("status-"+u); if(d)d.style.display=(s==='online'?'inline-block':'none'); }
            async function loadDMs() { let r=await fetch("/get_dms?username="+username); let d=await r.json(); document.getElementById("dm-list").innerHTML=""; d.forEach(u => { let div=document.createElement("div"); div.className="channel"; div.innerHTML=`<img src="${getDefaultAvatar(u)}" class="dm-avatar"><span style="flex-grow:1">${u}<span id="status-${u}" class="status-dot"></span></span>`; div.onclick=()=>switchChat("dm_"+[username,u].sort().join("_"), u, true); document.getElementById("dm-list").appendChild(div); }); }
            async function loadGroups() { let r=await fetch("/get_my_groups?username="+username); let d=await r.json(); document.getElementById("groups-list").innerHTML=""; d.forEach(g => { let div=document.createElement("div"); div.className="channel"; div.innerText=g.name; div.onclick=()=>switchChat("group_"+g.id, g.name, false, g.id); document.getElementById("groups-list").appendChild(div); }); }
            async function loadRequests() { let r=await fetch("/get_requests?username="+username); let d=await r.json(); document.getElementById("requests-list").innerHTML=""; document.getElementById("requests-section").style.display=d.length?"block":"none"; d.forEach(q => { let div=document.createElement("div"); div.className="channel"; div.style.cursor="default"; div.innerHTML=`${q.sender} <span class="icon-btn" onclick="respondReq(${q.id},'accept')" style="margin-left:auto">‚úÖ</span><span class="icon-btn" onclick="respondReq(${q.id},'reject')">‚ùå</span>`; document.getElementById("requests-list").appendChild(div); }); }
            function switchChat(id, name, isDm, gid) { currentChannel=id; currentGroupId=gid; document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active')); event.currentTarget.classList.add('active'); document.getElementById("header-title").innerText=name; document.getElementById("add-member-btn").style.display=gid?"block":"none"; document.getElementById("call-btn").style.display=isDm?"flex":"none"; document.getElementById("messages").innerHTML=""; requestHistory(); closeSidebarOnMobile(); }
            async function sendFriendRequest() { var u=document.getElementById("dm-username").value; if(u) fetch("/send_request", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender:username,receiver:u})}).then(r=>{if(r.ok){alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");document.getElementById("dm-modal").style.display="none";}else alert("–û—à–∏–±–∫–∞")}); }
            async function createGroup() { var n=document.getElementById("group-name-input").value; if(n) fetch("/create_group", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,owner:username})}).then(r=>{if(r.ok){document.getElementById("create-group-modal").style.display="none";loadGroups();}}); }
            async function addMemberToGroup() { var u=document.getElementById("new-member-username").value; if(u) fetch("/add_member", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group_id:currentGroupId,username:u})}).then(r=>{if(r.ok){alert("–î–æ–±–∞–≤–ª–µ–Ω");document.getElementById("add-member-modal").style.display="none";}else alert("–û—à–∏–±–∫–∞")}); }
            async function respondReq(id, act) { fetch("/respond_request", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:id,action:act})}).then(r=>{if(r.ok){loadRequests();if(act==='accept')loadDMs();}}); }
            async function viewProfile(u) { try { let r=await fetch("/get_profile?username="+u); if(!r.ok)return; let d=await r.json(); document.getElementById("view-username").innerHTML=d.username+(d.is_admin?ICONS.crown:""); document.getElementById("view-bio").innerText=d.bio; document.getElementById("view-avatar").src=d.avatar_url||getDefaultAvatar(d.username); document.getElementById("view-details").innerHTML=`–ò–º—è: ${d.real_name||"-"}<br>–ì–æ—Ä–æ–¥: ${d.location||"-"}<br>–î–†: ${d.birth_date||"-"}<br>–°–æ—Ü—Å–µ—Ç–∏: ${d.social_link||"-"}`; document.getElementById("user-profile-modal").style.display="flex"; } catch(e){} }
            async function saveProfile() { let body={username:username, bio:document.getElementById("settings-bio").value, avatar_url:currentUserAvatar, real_name:document.getElementById("settings-realname").value, location:document.getElementById("settings-location").value, birth_date:document.getElementById("settings-birthdate").value, social_link:document.getElementById("settings-social").value}; let r=await fetch("/update_profile", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)}); if(r.ok) { let d=await r.json(); updateMyUI(d); document.getElementById("settings-modal").style.display="none"; } }
            function previewAvatar(i) { if(i.files[0]) { var r=new FileReader(); r.onload=e=> { tempAvatarBase64=e.target.result; document.getElementById("settings-avatar-preview").src=tempAvatarBase64; currentUserAvatar=tempAvatarBase64; }; r.readAsDataURL(i.files[0]); } }
            async function toggleMic() { if(!isRecording){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(s);audioChunks=[];mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);mediaRecorder.onstop=()=>{const b=new Blob(audioChunks,{type:'audio/mp3'});const r=new FileReader();r.onload=()=>{ws.send(JSON.stringify({type:"message",channel:currentChannel,username:username,content:r.result}))};r.readAsDataURL(b);s.getTracks().forEach(t=>t.stop());};mediaRecorder.start();isRecording=true;document.getElementById("mic-btn").classList.add("recording");}catch(e){alert("Mic Error");}}else{mediaRecorder.stop();isRecording=false;document.getElementById("mic-btn").classList.remove("recording");}}
            document.getElementById("messageText").addEventListener("input", ()=>{var n=Date.now();if(n-lastTypingSent>2000&&ws&&currentChannel){ws.send(JSON.stringify({type:"typing",channel:currentChannel,username:username}));lastTypingSent=n;}});
            
            async function startCall() { if(!currentChannel.startsWith("dm_")) return; callTarget = document.getElementById("header-title").innerText; showCallUI(callTarget, "–ù–∞–±–æ—Ä...", false); try { localStream = await navigator.mediaDevices.getUserMedia({audio:true}); createPeer(); localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream)); const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); ws.send(JSON.stringify({type:"call_offer", target:callTarget, sender:username, offer:offer})); } catch(e) { alert("Mic Error: "+e); closeCall(); } }
            async function handleOffer(d) { callTarget = d.sender; showCallUI(callTarget, "–í—Ö–æ–¥—è—â–∏–π!", true); window.incomingOffer = d.offer; ringtone.play().catch(e=>{}); }
            async function answerCall() { ringtone.pause(); document.getElementById("answer-btn").style.display="none"; document.getElementById("call-status").innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."; try { localStream = await navigator.mediaDevices.getUserMedia({audio:true}); createPeer(); localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream)); await peerConnection.setRemoteDescription(new RTCSessionDescription(window.incomingOffer)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); ws.send(JSON.stringify({type:"call_answer", target:callTarget, answer:answer})); } catch(e) { alert("Mic Error"); hangUp(); } }
            async function handleAnswer(d) { await peerConnection.setRemoteDescription(new RTCSessionDescription(d.answer)); }
            async function handleCandidate(d) { try{if(peerConnection)await peerConnection.addIceCandidate(new RTCIceCandidate(d.candidate));}catch(e){} }
            function createPeer() { peerConnection = new RTCPeerConnection(rtcConfig); peerConnection.oniceconnectionstatechange = () => { let s = peerConnection.iceConnectionState; if(s==="connected") document.getElementById("call-status").innerText = "üü¢ –°–í–Ø–ó–¨!"; else if(s==="failed") document.getElementById("call-status").innerText = "üî¥ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; }; peerConnection.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({type:"new_ice_candidate", target:callTarget, candidate:e.candidate})); }; peerConnection.ontrack = e => { let ra = document.getElementById("remote-audio"); ra.srcObject = e.streams[0]; ra.play().catch(()=>{}); }; }
            function showCallUI(name, status, isIncoming) { document.getElementById("call-overlay").style.display="flex"; document.getElementById("call-username").innerText=name; document.getElementById("call-avatar").src=getDefaultAvatar(name); document.getElementById("call-status").innerText=status; document.getElementById("answer-btn").style.display=isIncoming?"flex":"none"; }
            function hangUp() { if(ws) ws.send(JSON.stringify({type:"hang_up", target:callTarget})); closeCall(); }
            function closeCall() { document.getElementById("call-overlay").style.display="none"; if(peerConnection) { peerConnection.close(); peerConnection=null; } if(localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream=null; } ringtone.pause(); ringtone.currentTime=0; }
        </script>
    </body>
</html>
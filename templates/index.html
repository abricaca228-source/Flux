<!DOCTYPE html>
<html>
    <head>
        <title>Flux</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;800&display=swap" rel="stylesheet">
        <style>
            :root {
                --bg-deep: #0f0c29;
                --bg-medium: #1a163a; 
                --bg-light: #302b63;
                --accent-primary: #00d2ff;
                --accent-secondary: #3a7bd5;
                --text-main: #ffffff;
                --text-dim: #b8b8d0;
                --danger: #ff416c;
                --success: #00f260;
                --glass: rgba(255, 255, 255, 0.05);
                --glass-border: rgba(255, 255, 255, 0.1);
            }

            * { box-sizing: border-box; }
            body { 
                background: linear-gradient(135deg, var(--bg-deep), #24243e); 
                color: var(--text-main); 
                font-family: 'Exo 2', sans-serif; 
                display: flex; height: 100vh; margin: 0; overflow: hidden; 
            }
            
            #login-screen { 
                display: flex; flex-direction: column; align-items: center; justify-content: center; 
                height: 100%; width: 100%; 
                background: radial-gradient(circle at center, #302b63 0%, #0f0c29 100%);
                z-index: 200; position: absolute; top: 0; left: 0; 
            }
            
            .logo-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
            .logo-f {
                font-size: 110px; font-weight: 900; line-height: 1;
                background: linear-gradient(to bottom, #00ffff, #0055ff);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                filter: drop-shadow(0 0 25px rgba(0, 210, 255, 0.7)); transform: skewX(-10deg);
            }
            .logo-text {
                font-size: 20px; font-weight: 600; letter-spacing: 8px; text-transform: uppercase;
                color: var(--accent-primary); opacity: 0.8; margin-top: -5px; text-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
            }

            .login-box { 
                background: rgba(15, 12, 41, 0.7); backdrop-filter: blur(20px);
                padding: 40px; border-radius: 20px; text-align: center; 
                width: 90%; max-width: 360px; border: 1px solid var(--glass-border);
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            }

            .login-input { 
                padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border); 
                background: rgba(0,0,0,0.3); color: white; width: 100%; margin-bottom: 20px; 
                font-size: 16px; outline: none; transition: 0.3s; font-family: 'Exo 2', sans-serif;
            }
            .login-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }

            .btn-group { display: flex; gap: 15px; flex-direction: column; }
            .btn { 
                width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; 
                font-weight: bold; color: white; transition: 0.3s; font-size: 16px;
                font-family: 'Exo 2', sans-serif; text-transform: uppercase; letter-spacing: 1px;
            }
            .btn-login { background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); box-shadow: 0 5px 15px rgba(0, 210, 255, 0.3); }
            .btn-login:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 210, 255, 0.6); }
            .btn-register { background: transparent; border: 1px solid var(--glass-border); }
            .btn-register:hover { background: var(--glass); border-color: var(--accent-primary); }

            .error-msg { color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none; }

            #app-container { display: none; width: 100%; height: 100%; }

            .sidebar { 
                width: 260px; background: rgba(15, 12, 41, 0.95); 
                border-right: 1px solid var(--glass-border);
                display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; 
                transition: transform 0.3s ease; 
            }
            
            .sidebar-title { 
                font-weight: 800; padding: 20px 15px 10px 15px; 
                color: var(--text-dim); font-size: 12px; letter-spacing: 2px;
                text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; 
            }
            .add-btn { cursor: pointer; font-size: 20px; color: var(--accent-primary); transition: 0.2s; }
            .add-btn:hover { text-shadow: 0 0 10px var(--accent-primary); transform: scale(1.1); }

            .channel { 
                padding: 12px 15px; margin: 4px 10px; border-radius: 8px; cursor: pointer; 
                color: var(--text-dim); font-weight: 600; display: flex; align-items: center; 
                position: relative; transition: 0.2s; font-size: 15px;
            }
            .channel:hover { background: var(--glass); color: white; }
            .channel.active { 
                background: linear-gradient(90deg, rgba(0, 210, 255, 0.1), transparent); 
                color: var(--accent-primary); border-left: 3px solid var(--accent-primary);
            }
            
            .sidebar-ban-btn { display: none; margin-left: auto; color: var(--danger); font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 14px; }
            .channel:hover .sidebar-ban-btn { display: block; }

            .hashtag { display: none; } 
            .dm-avatar { width: 32px; height: 32px; border-radius: 10px; margin-right: 10px; background: linear-gradient(135deg, #667eea, #764ba2); flex-shrink: 0; object-fit: cover;}
            
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –Æ–ó–ï–†–ê --- */
            .user-panel { 
                background: rgba(0,0,0,0.4); padding: 15px; display: flex; align-items: center; cursor: pointer; 
                margin-top: auto; border-top: 1px solid var(--glass-border);
                position: relative; z-index: 50; /* –ü–æ–¥–Ω–∏–º–∞–µ–º —Å–ª–æ–π –≤—ã—à–µ –≤—Å–µ—Ö */
            }
            .user-panel:hover { background: rgba(0,0,0,0.6); }

            .my-avatar { width: 40px; height: 40px; border-radius: 12px; background-color: #5865f2; margin-right: 12px; object-fit: cover; border: 2px solid var(--bg-deep); }
            .my-info { flex-grow: 1; overflow: hidden; }
            .my-name { font-weight: bold; font-size: 16px; color: white; display: flex; align-items: center;}
            .my-bio { font-size: 12px; color: var(--accent-primary); }
            .settings-icon { color: var(--text-dim); font-size: 18px; cursor: pointer; }

            .chat-area { 
                flex-grow: 1; display: flex; flex-direction: column; 
                background: radial-gradient(circle at top right, #1a163a 0%, #0f0c29 60%);
                min-width: 0; width: 100%; position: relative; 
            }
            
            .chat-header { 
                height: 60px; border-bottom: 1px solid var(--glass-border); 
                display: flex; align-items: center; padding: 0 20px; 
                font-weight: 800; color: white; flex-shrink: 0; font-size: 18px; letter-spacing: 0.5px;
                background: rgba(15, 12, 41, 0.8); backdrop-filter: blur(10px); z-index: 10; 
            }
            .hamburger { display: none; margin-right: 15px; font-size: 24px; cursor: pointer; color: white; }
            
            .add-member-header-btn { 
                margin-left: auto; cursor: pointer; 
                background: linear-gradient(90deg, var(--success), #00b09b);
                color: #0f0c29; font-weight: 800;
                padding: 6px 14px; border-radius: 20px; font-size: 13px; display: none; 
                box-shadow: 0 0 10px rgba(0, 242, 96, 0.2);
            }

            #messages { list-style-type: none; margin: 0; padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
            
            .message { display: flex; align-items: flex-start; width: 100%; padding: 5px 10px; border-radius: 8px; transition: 0.2s; }
            .message:hover { background: var(--glass); }
            
            .avatar { width: 42px; height: 42px; border-radius: 14px; background-color: #5865f2; margin-right: 15px; flex-shrink: 0; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
            
            .content { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }
            .username-row { display: flex; align-items: center; margin-bottom: 4px; flex-wrap: wrap; }
            .username { font-weight: 700; color: var(--accent-primary); font-size: 16px; margin-right: 8px; }
            .admin-crown { margin-left: 2px; font-size: 16px; margin-right: 8px; filter: drop-shadow(0 0 5px gold);}
            .timestamp { color: var(--text-dim); font-size: 11px; font-weight: 400; margin-left: 5px; }
            .bio-tag { font-size: 10px; color: rgba(255,255,255,0.7); margin-left: 8px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
            .text { color: #e0e0e0; font-size: 15px; line-height: 1.5; word-break: break-word; font-weight: 400; }
            
            .chat-image { max-width: 100%; height: auto; max-height: 300px; border-radius: 12px; margin-top: 8px; cursor: pointer; object-fit: cover; display: block; border: 1px solid var(--glass-border); }
            audio { margin-top: 5px; height: 32px; width: 100%; max-width: 300px; filter: invert(0.9); }

            .delete-btn { opacity: 0; cursor: pointer; font-size: 18px; padding: 8px; color: var(--danger); flex-shrink: 0; margin-left: auto; transition: opacity 0.2s; }
            .message:hover .delete-btn { opacity: 1; }

            .system-msg { text-align: center; color: var(--danger); font-weight: bold; margin: 10px 0; border: 1px solid var(--danger); background: rgba(255, 65, 108, 0.1); padding: 8px; border-radius: 8px; font-size: 13px; }

            #typing-indicator { padding: 0 20px 10px 20px; color: var(--accent-primary); font-size: 12px; font-weight: bold; height: 20px; opacity: 0; transition: opacity 0.2s; }
            #typing-indicator.show { opacity: 1; }
            .typing-dots { animation: blink 1.4s infinite both; }
            .typing-dots:nth-child(2) { animation-delay: .2s; }
            .typing-dots:nth-child(3) { animation-delay: .4s; }
            @keyframes blink { 0% {opacity: .2;} 20% {opacity: 1;} 100% {opacity: .2;} }

            form { padding: 0 20px 20px 20px; margin: 0; width: 100%; flex-shrink: 0; background: transparent; }
            .input-wrapper { 
                background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
                border-radius: 12px; display: flex; align-items: center; padding: 5px 15px; width: 100%; 
                backdrop-filter: blur(5px); transition: 0.3s;
            }
            .input-wrapper:focus-within { border-color: var(--accent-primary); box-shadow: 0 0 15px rgba(0, 210, 255, 0.15); }
            
            input[type="text"] { flex-grow: 1; padding: 12px; border: none; background: transparent; color: white; outline: none; font-size: 16px; width: 100%; font-family: 'Exo 2', sans-serif;}
            .file-btn, .mic-btn { cursor: pointer; color: var(--text-dim); padding: 10px; font-size: 22px; flex-shrink: 0; transition: 0.2s; }
            .file-btn:hover, .mic-btn:hover { color: white; }
            .mic-btn.recording { color: var(--danger); animation: pulse 1s infinite; text-shadow: 0 0 10px var(--danger); }
            @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

            .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
            .modal-content { 
                background: #1a163a; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; position: relative; 
                border: 1px solid var(--glass-border); box-shadow: 0 20px 60px rgba(0,0,0,0.6); color: white;
            }
            .modal-content h2 { margin-top: 0; color: var(--accent-primary); }
            #modal-img { max-width: 100%; max-height: 80vh; border-radius: 8px; }
            .close-btn { position: absolute; top: 15px; right: 20px; color: var(--text-dim); font-size: 24px; cursor: pointer; }
            .profile-preview { width: 100px; height: 100px; border-radius: 25px; background: #5865f2; margin: 0 auto 20px; object-fit: cover; border: 3px solid var(--accent-primary); box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); }
            .settings-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; outline: none; font-family: 'Exo 2', sans-serif;}
            .settings-input:focus { border-color: var(--accent-secondary); }
            
            @media (max-width: 768px) {
                .sidebar { position: absolute; z-index: 100; height: 100%; width: 280px; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.8); }
                .sidebar.open { transform: translateX(0); }
                .hamburger { display: block; } 
                #overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; backdrop-filter: blur(2px); }
                #overlay.show { display: block; }
                form { padding: 10px; }
                .delete-btn { opacity: 1 !important; }
            }
        </style>
    </head>
    <body>
        <div id="image-modal" class="modal" onclick="this.style.display='none'">
            <span class="close-btn">&times;</span>
            <img id="modal-img">
        </div>

        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="document.getElementById('settings-modal').style.display='none'">&times;</span>
                <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <img id="settings-avatar-preview" class="profile-preview" src="">
                <label class="btn btn-login" style="display:block; margin-bottom:15px;">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                    <input type="file" style="display: none;" accept="image/*" onchange="previewAvatar(this)">
                </label>
                <input type="text" id="settings-bio" class="settings-input" placeholder="–û —Å–µ–±–µ">
                <button class="btn btn-login" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div id="dm-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="document.getElementById('dm-modal').style.display='none'">&times;</span>
                <h2>–ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞</h2>
                <input type="text" id="dm-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º">
                <button class="btn btn-login" onclick="sendFriendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="create-group-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="document.getElementById('create-group-modal').style.display='none'">&times;</span>
                <h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
                <input type="text" id="group-name-input" class="settings-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                <button class="btn btn-login" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>

        <div id="add-member-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="document.getElementById('add-member-modal').style.display='none'">&times;</span>
                <h2>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
                <input type="text" id="new-member-username" class="settings-input" placeholder="–ù–∏–∫–Ω–µ–π–º –¥—Ä—É–≥–∞">
                <button class="btn btn-login" onclick="addMemberToGroup()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="login-screen">
            <div class="logo-container">
                <div class="logo-f">F</div>
                <div class="logo-text">Flux</div>
            </div>
            
            <div class="login-box">
                <input type="text" id="usernameInput" class="login-input" placeholder="–ù–∏–∫–Ω–µ–π–º" />
                <input type="password" id="passwordInput" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" />
                <div id="errorMsg" class="error-msg">–û—à–∏–±–∫–∞</div>
                <div class="btn-group">
                    <button class="btn btn-login" onclick="auth('login')">–í–æ–π—Ç–∏</button>
                    <button class="btn btn-register" onclick="auth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>
            </div>
        </div>

        <div id="app-container">
            <div id="overlay" onclick="toggleSidebar()"></div>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-title">
                    –ì—Ä—É–ø–ø—ã
                    <span class="add-btn" onclick="document.getElementById('create-group-modal').style.display='flex'">+</span>
                </div>
                <div id="groups-list"></div>

                <div class="sidebar-title">
                    –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    <span class="add-btn" onclick="document.getElementById('dm-modal').style.display='flex'">+</span>
                </div>
                <div id="dm-list"></div>
                
                <div id="requests-section" style="margin-top: 10px; display: none;">
                    <div class="sidebar-title" style="color: var(--accent-secondary);">–ó–∞—è–≤–∫–∏</div>
                    <div id="requests-list"></div>
                </div>

                <div class="user-panel" onclick="openSettings()">
                    <img id="my-avatar-img" class="my-avatar" src="">
                    <div class="my-info">
                        <div id="my-name-text" class="my-name">User</div>
                        <div id="my-bio-text" class="my-bio">Online</div>
                    </div>
                    <div class="settings-icon">‚öôÔ∏è</div>
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <span class="hamburger" onclick="toggleSidebar()">‚ò∞</span>
                    <span id="header-icon" style="margin-right: 5px; color: var(--accent-primary);"></span> 
                    <span id="header-title">Flux</span>
                    <span id="add-member-btn" class="add-member-header-btn" onclick="document.getElementById('add-member-modal').style.display='flex'">üë§+ –î–æ–±–∞–≤–∏—Ç—å</span>
                </div>
                <ul id='messages'></ul>
                <div id="typing-indicator"></div>
                <form action="" onsubmit="sendMessage(event)">
                    <div class="input-wrapper">
                        <label class="file-btn">+<input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(this)"></label>
                        <input type="text" id="messageText" autocomplete="off" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
                        <div id="mic-btn" class="mic-btn" onclick="toggleMic()">üé§</div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            var ws = null;
            var username = "";
            var currentUserAvatar = ""; 
            var currentUserBio = "";
            var myIsAdmin = false;

            var currentChannel = ""; 
            var currentGroupId = null; 

            var mediaRecorder = null;
            var audioChunks = [];
            var isRecording = false;
            var typingTimeout;
            var lastTypingSent = 0;
            var tempAvatarBase64 = null;

            function getDefaultAvatar(name) {
                return `https://ui-avatars.com/api/?name=${name}&background=0f0c29&color=00d2ff&size=128&bold=true&font-size=0.5`;
            }

            function toggleSidebar() {
                var sidebar = document.getElementById("sidebar");
                var overlay = document.getElementById("overlay");
                sidebar.classList.toggle("open");
                overlay.classList.toggle("show");
            }
            function closeSidebarOnMobile() { if (window.innerWidth <= 768) toggleSidebar(); }
            
            // –û–¢–ö–†–´–¢–ò–ï –ù–ê–°–¢–†–û–ï–ö
            function openSettings() {
                document.getElementById("settings-modal").style.display = 'flex';
                document.getElementById("settings-bio").value = currentUserBio;
                document.getElementById("settings-avatar-preview").src = currentUserAvatar;
            }

            async function auth(type) {
                var user = document.getElementById("usernameInput").value;
                var pass = document.getElementById("passwordInput").value;
                if (!user || !pass) return;
                try {
                    let response = await fetch("/" + type, {
                        method: "POST", headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({username: user, password: pass})
                    });
                    if (response.ok) {
                        let data = await response.json();
                        username = user;
                        myIsAdmin = data.is_admin;
                        updateMyProfileUI(data.avatar_url, data.bio);
                        loadDMs(); 
                        loadGroups();
                        loadRequests();
                        document.getElementById("login-screen").style.display = "none";
                        document.getElementById("app-container").style.display = "flex";
                        connectWebSocket();
                    } else {
                        let result = await response.json();
                        document.getElementById("errorMsg").innerText = result.detail;
                        document.getElementById("errorMsg").style.display = "block";
                    }
                } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"); }
            }

            async function loadGroups() {
                let response = await fetch("/get_my_groups?username=" + username);
                let groups = await response.json();
                var list = document.getElementById("groups-list");
                list.innerHTML = "";
                groups.forEach(g => {
                    var div = document.createElement("div");
                    div.className = "channel";
                    div.innerHTML = `${g.name}`;
                    div.onclick = function() { switchChannel("group_" + g.id, g.name, false, g.id); };
                    list.appendChild(div);
                });
            }

            async function createGroup() {
                var name = document.getElementById("group-name-input").value;
                if (!name) return;
                let response = await fetch("/create_group", {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({name: name, owner: username})
                });
                if (response.ok) {
                    document.getElementById("create-group-modal").style.display = "none";
                    document.getElementById("group-name-input").value = "";
                    loadGroups();
                }
            }

            async function addMemberToGroup() {
                var memberName = document.getElementById("new-member-username").value;
                if (!memberName || !currentGroupId) return;
                let response = await fetch("/add_member", {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({group_id: currentGroupId, username: memberName})
                });
                if (response.ok) {
                    alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!");
                    document.getElementById("add-member-modal").style.display = "none";
                    document.getElementById("new-member-username").value = "";
                } else {
                    let res = await response.json();
                    alert("–û—à–∏–±–∫–∞: " + res.detail);
                }
            }

            async function loadDMs() {
                let response = await fetch("/get_dms?username=" + username);
                let dms = await response.json();
                var dmList = document.getElementById("dm-list");
                dmList.innerHTML = "";
                dms.forEach(friend => addDMToSidebar(friend));
            }

            async function loadRequests() {
                let response = await fetch("/get_requests?username=" + username);
                let reqs = await response.json();
                var list = document.getElementById("requests-list");
                var section = document.getElementById("requests-section");
                list.innerHTML = "";
                if (reqs.length > 0) {
                    section.style.display = "block";
                    reqs.forEach(req => {
                        var div = document.createElement("div");
                        div.className = "channel"; 
                        div.style.cursor = "default";
                        div.innerHTML = `${req.sender} <span style="margin-left:auto; cursor:pointer;" onclick="respondRequest(${req.id}, 'accept')">‚úÖ</span> <span style="margin-left:5px; cursor:pointer;" onclick="respondRequest(${req.id}, 'reject')">‚ùå</span>`;
                        list.appendChild(div);
                    });
                } else {
                    section.style.display = "none";
                }
            }

            async function sendFriendRequest() {
                var friendName = document.getElementById("dm-username").value;
                if(!friendName) return;
                let response = await fetch("/send_request", {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({sender: username, receiver: friendName})
                });
                if(response.ok) {
                    document.getElementById("dm-modal").style.display = "none";
                    alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
                } else { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ"); }
            }

            async function respondRequest(reqId, action) {
                let response = await fetch("/respond_request", {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({request_id: reqId, action: action})
                });
                if (response.ok) { loadRequests(); if (action === 'accept') loadDMs(); }
            }

            function getDMChannelID(u1, u2) {
                var sorted = [u1, u2].sort();
                return "dm_" + sorted[0] + "_" + sorted[1];
            }

            function addDMToSidebar(friendName) {
                var dmList = document.getElementById("dm-list");
                var existing = Array.from(dmList.children).find(div => div.innerText.includes(friendName));
                if (existing) return;
                
                var div = document.createElement("div");
                div.className = "channel";
                
                var banBtnHtml = "";
                if (myIsAdmin) {
                    banBtnHtml = `<span class="sidebar-ban-btn" onclick="event.stopPropagation(); banUser('${friendName}')" title="–ó–ê–ë–ê–ù–ò–¢–¨">‚õî</span>`;
                }
                
                var avatarUrl = getDefaultAvatar(friendName);
                div.innerHTML = `<img src="${avatarUrl}" class="dm-avatar"> <span style="flex-grow:1;">${friendName}</span> ${banBtnHtml}`;
                var channelID = getDMChannelID(username, friendName);
                div.onclick = function() { switchChannel(channelID, friendName, true); };
                dmList.appendChild(div);
            }

            function updateMyProfileUI(avatar, bio) {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∫–∞ —Å –¥–∏—Å–∫–æ—Ä–¥–∞ –∏–ª–∏ –ø—É—Å—Ç–∞—è - –∑–∞–º–µ–Ω—è–µ–º
                if (!avatar || avatar.includes("discordapp")) {
                    currentUserAvatar = getDefaultAvatar(username);
                } else {
                    currentUserAvatar = avatar;
                }
                
                currentUserBio = bio || "–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞";
                
                var nameHtml = username;
                if (myIsAdmin) {
                    nameHtml += `<span class="admin-crown" title="Admin">üëë</span>`;
                }
                
                document.getElementById("my-name-text").innerHTML = nameHtml;
                document.getElementById("my-name-text").classList.remove("admin-name"); 
                document.getElementById("my-bio-text").innerText = currentUserBio;
                document.getElementById("my-avatar-img").src = currentUserAvatar;
            }

            function switchChannel(channelID, displayName, isDM = false, groupId = null) {
                currentChannel = channelID;
                currentGroupId = groupId; 
                document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                var title = isDM ? displayName : displayName;
                var icon = isDM ? "@" : ""; 
                document.getElementById("header-title").innerText = title;
                document.getElementById("header-icon").innerText = icon;
                
                if (groupId) {
                    document.getElementById("add-member-btn").style.display = "block";
                } else {
                    document.getElementById("add-member-btn").style.display = "none";
                }

                document.getElementById('messages').innerHTML = '';
                document.getElementById('typing-indicator').className = ""; 
                closeSidebarOnMobile(); 
                requestHistory();
            }

            function compressImage(file, callback) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext("2d");
                        var maxWidth = 800;
                        var scale = maxWidth / img.width;
                        if (scale > 1) scale = 1;
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        var dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                        callback(dataUrl);
                    }
                }
                reader.readAsDataURL(file);
            }

            async function toggleMic() {
                if (!isRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = () => {
                                if (ws && currentChannel) ws.send(JSON.stringify({type: "message", channel: currentChannel, username: username, content: reader.result}));
                            };
                            stream.getTracks().forEach(track => track.stop());
                        };
                        mediaRecorder.start();
                        isRecording = true;
                        document.getElementById("mic-btn").classList.add("recording");
                    } catch(err) { alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞"); }
                } else {
                    mediaRecorder.stop();
                    isRecording = false;
                    document.getElementById("mic-btn").classList.remove("recording");
                }
            }

            function connectWebSocket() {
                var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(protocol + "//" + window.location.host + "/ws/" + username);
                ws.onopen = function() { 
                    if (currentChannel) requestHistory(); 
                };
                ws.onmessage = function(event) {
                    var data = JSON.parse(event.data);
                    if (Array.isArray(data)) {
                        document.getElementById('messages').innerHTML = '';
                        data.reverse().forEach(msg => addMessageToUI(msg));
                    } 
                    else if (data.type === "delete") {
                        var msgElement = document.getElementById("msg-" + data.message_id);
                        if (msgElement) msgElement.remove();
                    }
                    else if (data.type === "new_request") loadRequests(); 
                    else if (data.type === "request_accepted") loadDMs(); 
                    else if (data.type === "ban") {
                        alert("–í–ê–° –ó–ê–ë–ê–ù–ò–õ–ò!");
                        location.reload(); 
                    }
                    else if (data.type === "system") {
                        var li = document.createElement('li');
                        li.className = "system-msg";
                        li.innerText = data.content;
                        document.getElementById('messages').appendChild(li);
                        loadDMs();
                    }
                    else if (data.type === "typing") {
                        if (data.channel === currentChannel && data.username !== username) {
                            var indicator = document.getElementById("typing-indicator");
                            indicator.innerHTML = `<b>${data.username}</b> –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots">.</span><span class="typing-dots">.</span><span class="typing-dots">.</span>`;
                            indicator.classList.add("show");
                            clearTimeout(typingTimeout);
                            typingTimeout = setTimeout(() => { indicator.classList.remove("show"); }, 3000);
                        }
                    }
                    else if (data.channel === currentChannel) {
                        addMessageToUI(data);
                        if(data.username !== username) document.getElementById("typing-indicator").classList.remove("show");
                    }
                };
            }

            function requestHistory() {
                if(ws && ws.readyState === WebSocket.OPEN && currentChannel) {
                    ws.send(JSON.stringify({type: "history", channel: currentChannel}));
                }
            }

            function addMessageToUI(data) {
                var messages = document.getElementById('messages');
                if (document.getElementById("msg-" + data.id)) return;
                var li = document.createElement('li');
                li.className = "message";
                li.id = "msg-" + data.id;
                var contentHtml = "";
                if (data.content.startsWith("data:image")) contentHtml = `<img src="${data.content}" class="chat-image" onclick="document.getElementById('image-modal').style.display='flex';document.getElementById('modal-img').src=this.src;">`;
                else if (data.content.startsWith("data:audio")) contentHtml = `<audio controls src="${data.content}"></audio>`;
                else contentHtml = `<div class="text">${data.content}</div>`;

                var deleteBtn = "";
                if (data.username === username || myIsAdmin) {
                    deleteBtn = `<div class="delete-btn" onclick="deleteMessage(${data.id})">üóëÔ∏è</div>`;
                }
                
                var nameHtml = `<span class="username">${data.username}</span>`;
                if (data.is_admin) {
                    nameHtml += `<span class="admin-crown" title="Admin">üëë</span>`;
                }

                var avatarSrc = data.avatar_url;
                if (!avatarSrc || avatarSrc.includes("discordapp")) {
                    avatarSrc = getDefaultAvatar(data.username);
                }
                
                li.innerHTML = `
                    <img class="avatar" src="${avatarSrc}">
                    <div class="content">
                        <div class="username-row">
                            ${nameHtml}
                            <span class="timestamp">${data.created_at}</span>
                            <span class="bio-tag">${data.bio || ""}</span>
                        </div>
                        ${contentHtml}
                    </div>
                    ${deleteBtn}
                `;
                messages.appendChild(li);
                messages.scrollTop = messages.scrollHeight;
            }

            function deleteMessage(id) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) ws.send(JSON.stringify({type: "delete", message_id: id}));
            }
            
            function banUser(targetName) {
                if(confirm(`–í–´ –¢–û–ß–ù–û –•–û–¢–ò–¢–ï –ó–ê–ë–ê–ù–ò–¢–¨ ${targetName} –ù–ê–í–°–ï–ì–î–ê?`)) {
                    ws.send(JSON.stringify({type: "ban_user", target: targetName}));
                }
            }
            
            function handleFileSelect(input) {
                if (input.files[0]) compressImage(input.files[0], base64 => { if (ws) ws.send(JSON.stringify({type: "message", channel: currentChannel, username: username, content: base64})); });
                input.value = '';
            }
            function sendMessage(event) {
                event.preventDefault();
                var input = document.getElementById("messageText");
                if (input.value.trim() !== "" && ws && currentChannel) {
                    ws.send(JSON.stringify({type: "message", channel: currentChannel, username: username, content: input.value}));
                    input.value = '';
                }
            }
            async function saveProfile() {
                var newBio = document.getElementById("settings-bio").value;
                var newAvatar = tempAvatarBase64 || currentUserAvatar;
                
                let response = await fetch("/update_profile", {
                    method: "POST", headers: {"Content-Type": "application/json"}, 
                    body: JSON.stringify({username: username, bio: newBio, avatar_url: newAvatar})
                });
                if (response.ok) {
                    let data = await response.json();
                    myIsAdmin = data.is_admin;
                    currentUserBio = data.bio;
                    updateMyProfileUI(newAvatar, data.bio);
                    document.getElementById("settings-modal").style.display = "none";
                    loadDMs();
                    if(currentChannel) requestHistory(); 
                } else { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!"); }
            }
            
            function previewAvatar(input) {
                if (input.files[0]) compressImage(input.files[0], base64 => { tempAvatarBase64 = base64; document.getElementById("settings-avatar-preview").src = tempAvatarBase64; });
            }

            document.getElementById("messageText").addEventListener("input", function() {
                var now = Date.now();
                if (now - lastTypingSent > 2000 && ws && currentChannel) {
                    ws.send(JSON.stringify({type: "typing", channel: currentChannel, username: username}));
                    lastTypingSent = now;
                }
            });
        </script>
    </body>
</html>